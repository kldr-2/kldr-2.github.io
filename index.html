<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hani's World Tour Matcha Caf√©</title>
    <!-- Pixel Font -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            /* DYNAMIC PALETTE (Default: Hungary/Christmas) */
            --bg-color: #8f1e1e;      /* Christmas Red */
            --bg-pattern: #165b33;    /* Christmas Green */
            --panel-bg: #f0f0f0;      /* Snow White */
            --primary: #165b33;       /* Pine Green */
            --accent: #d4af37;        /* Gold */
            --text-color: #212121;
            --border-color: #000000;
            --news-bg: #212121;       
            
            --border-width: 4px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(45deg, var(--bg-pattern) 25%, transparent 25%, transparent 75%, var(--bg-pattern) 75%, var(--bg-pattern)), 
                linear-gradient(45deg, var(--bg-pattern) 25%, transparent 25%, transparent 75%, var(--bg-pattern) 75%, var(--bg-pattern));
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            color: var(--text-color);
            font-family: 'VT323', monospace;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
            display: flex;
            flex-direction: column; 
            transition: background-color 1s ease;
        }

        /* --- OVERLAYS --- */
        #language-overlay, #intro-overlay, #tutorial-overlay, #location-popup, #stats-overlay, #menu-overlay, #map-overlay, #newspaper-overlay, #reset-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        #intro-overlay, #tutorial-overlay, #location-popup, #stats-overlay, #menu-overlay, #map-overlay, #newspaper-overlay, #reset-overlay { display: none; }

        .modal-box {
            background: var(--panel-bg);
            border: 6px solid var(--primary);
            padding: 20px;
            max-width: 600px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            color: #212121;
        }

        .modal-box h1, .modal-box h2 {
            color: var(--accent);
            font-size: 2.5rem;
            margin: 0 0 15px 0;
            text-transform: uppercase;
            text-shadow: 2px 2px 0px #000;
        }

        .modal-box p { font-size: 1.3rem; line-height: 1.4; margin-bottom: 20px; }

        /* Generic Button Style */
        .pixel-btn {
            background: var(--bg-color);
            color: white;
            border: 4px solid black;
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            padding: 10px 20px;
            cursor: pointer;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            transition: transform 0.1s;
            text-shadow: 1px 1px 0 #000;
            margin: 5px;
            display: inline-block;
            user-select: none;
        }
        .pixel-btn:active { transform: scale(0.95); box-shadow: 2px 2px 0px rgba(0,0,0,0.5); }

        .pixel-btn.small {
            font-size: 1rem;
            padding: 5px 10px;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.5);
        }

        /* --- NEWSPAPER POPUP --- */
        .newspaper {
            background: #fdf6e3;
            border: 4px solid #212121;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            color: #212121;
            text-align: center;
            box-shadow: 10px 10px 0px rgba(0,0,0,0.5);
            position: relative;
        }
        .news-header { border-bottom: 4px double #212121; margin-bottom: 15px; padding-bottom: 10px; }
        .news-logo { font-size: 3rem; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }
        .news-sub { font-size: 1rem; text-transform: uppercase; letter-spacing: 2px; }
        .news-headline { font-size: 2rem; margin: 15px 0; font-weight: bold; line-height: 1; }
        .news-body { font-size: 1.3rem; margin-bottom: 20px; }
        .news-close { position: absolute; top: -10px; right: -10px; background: red; color: white; border: 2px solid black; width: 30px; height: 30px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* --- SNOW EFFECT --- */
        .snowflake {
            position: fixed; top: -10px; z-index: 9999; user-select: none; pointer-events: none; color: white;
            animation: fall linear forwards;
        }
        @keyframes fall { to { transform: translateY(105vh); } }

        /* --- LAYOUT --- */
        #game-container { 
            display: flex; 
            flex: 1; 
            padding: 10px; 
            box-sizing: border-box; 
            gap: 10px; 
            overflow: hidden; 
            height: calc(100vh - 40px); /* Minus news bar */
        }

        /* LEFT PANEL */
        .left-panel {
            flex: 1; 
            background: var(--panel-bg); 
            border: var(--border-width) solid var(--border-color);
            box-shadow: 6px 6px 0px rgba(0,0,0,0.5); 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: space-between; 
            padding: 10px; 
            color: #212121; 
            position: relative;
            min-width: 250px;
        }

        #menu-btn { position: absolute; top: 5px; left: 5px; z-index: 100; }

        .resource-display { 
            text-align: center; 
            margin-top: 30px;
            background: #fff; 
            padding: 5px 15px; 
            border: 3px solid black; 
            box-shadow: 4px 4px 0px #888; 
            width: 90%; 
        }
        #resource-count { font-size: 3.5rem; font-weight: bold; color: var(--primary); line-height: 1; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); word-break: break-all; }
        #rps-display { font-size: 1.4rem; color: var(--accent); text-transform: uppercase; }
        #active-rps { font-size: 1rem; color: #555; min-height: 1.2em; }

        #click-btn-container { position: relative; width: 220px; height: 220px; display: flex; align-items: center; justify-content: center; }
        #click-btn {
            width: 180px; height: 180px; background-color: var(--primary); border: 6px solid var(--border-color); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 5rem; cursor: pointer;
            box-shadow: 0px 8px 0px rgba(0,0,0,0.3); position: relative; z-index: 10; transition: transform 0.05s;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            outline: none;
        }
        #click-btn:focus { outline: none; }
        #click-btn:active, #click-btn.bump { transform: scale(0.95); box-shadow: none; }
        #click-btn::after { content: "üçµ"; filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.5)); }

        /* ORBITS */
        .orbit-wrapper { position: absolute; width: 100%; height: 100%; z-index: 20; pointer-events: none; display: none; }
        .orbiter-sprite { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3.5rem; transition: margin-top 0.1s; }
        #dylan-sprite { margin-top: -80px; } 
        #heart-sprite { margin-top: -110px; font-size: 2.5rem; }
        #dylan-sprite.hitting { margin-top: -40px; } 
        #heart-sprite.hitting { margin-top: -40px; }

        /* PROGRESS BAR */
        .progress-container { width: 100%; height: 20px; background-color: #ddd; border: 3px solid black; margin-top: 5px; position: relative; }
        .progress-fill { height: 100%; background-color: var(--primary); width: 0%; transition: width 0.5s; }

        /* RIGHT PANEL */
        .right-panel {
            flex: 1.5; 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            overflow: hidden;
            background: transparent; 
            gap: 0; 
            box-shadow: 6px 6px 0px rgba(0,0,0,0.5);
            border: var(--border-width) solid var(--border-color); 
            background: var(--panel-bg); 
            color: #212121;
        }

        /* CAFE SCENE */
        #cafe-scene { height: 150px; flex-shrink: 0; background-color: #aed581; border-bottom: var(--border-width) solid var(--border-color); position: relative; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .scene-label { position: absolute; top: 5px; left: 10px; background: black; color: white; padding: 2px 8px; font-size: 1rem; z-index: 5; cursor: pointer; transition: 0.1s; border: 2px solid white; }
        #sprite-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .bouncing-sprite { position: absolute; font-size: 2rem; will-change: transform; line-height: 1; user-select: none; }

        /* INFO PANEL */
        #info-panel { height: 80px; flex-shrink: 0; background: #fff; border-bottom: var(--border-width) solid var(--border-color); padding: 5px 10px; display: flex; align-items: center; gap: 10px; }
        #info-icon-container { width: 50px; height: 50px; background: #eee; border: 3px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; flex-shrink: 0; }
        #info-text { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        #info-title { margin: 0; font-size: 1.2rem; color: var(--accent); text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #info-desc { margin: 0; font-size: 1rem; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #info-cost { font-weight: bold; color: var(--primary); font-size: 1rem; }

        /* TABS */
        .tabs-header { display: flex; height: 40px; flex-shrink: 0; background: #ddd; border-bottom: var(--border-width) solid var(--border-color); }
        .tab-btn { flex: 1; border: none; background: #ccc; font-family: inherit; font-size: 1.2rem; cursor: pointer; border-right: 2px solid var(--border-color); }
        .tab-btn:last-child { border-right: none; }
        .tab-btn.active { background: var(--panel-bg); font-weight: bold; color: var(--accent); border-bottom: none; }

        /* SCROLL CONTENT */
        .tab-content { flex: 1; overflow-y: auto; padding: 10px; display: none; }
        .tab-content.active { display: block; }

        /* SHOP ITEMS */
        .shop-item { background: white; border: 3px solid black; margin-bottom: 8px; padding: 5px; display: flex; align-items: center; cursor: pointer; }
        .shop-item.disabled { background: #e0e0e0; opacity: 0.6; filter: grayscale(1); }
        .item-icon { font-size: 1.8rem; width: 40px; text-align: center; }
        .item-details { flex: 1; padding: 0 10px; }
        .item-details h3 { margin: 0; font-size: 1.2rem; }
        .item-right { text-align: right; }
        .item-cost { font-weight: bold; color: var(--accent); font-size: 1rem; }
        .item-count { background: black; color: white; padding: 0 5px; border-radius: 4px; font-size: 0.9rem; }

        /* UPGRADES */
        .upgrades-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; }
        .upgrade-card { height: 50px; background: var(--accent); border: 3px solid black; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: white; cursor: pointer; }
        .passive-row { border-bottom: 1px dashed #ccc; padding: 5px 0; display: flex; align-items: center; font-size: 1rem; }

        /* STATS TABLE */
        .stats-table { width: 100%; text-align: left; margin-bottom: 20px; font-size: 1rem; border-collapse: collapse; }
        .stats-table td, .stats-table th { border-bottom: 1px solid #ccc; padding: 5px; }

        /* MAP */
        .pixel-map { width: 100%; aspect-ratio: 2/1; background-color: #2196f3; position: relative; border: 4px solid black; margin: 0 auto; overflow: hidden; background-image: linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px); background-size: 20px 20px; }
        .continent { position: absolute; background: #4caf50; border: 2px solid #1b5e20; box-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
        /* Scale Continents down slightly for responsive map container */
        .c-americas { width: 20%; height: 80%; top: 5%; left: 10%; clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 80% 30%, 60% 40%, 80% 60%, 80% 80%, 60% 100%, 20% 90%, 0% 60%, 20% 40%, 0% 20%); }
        .c-eur-afr { width: 22%; height: 70%; top: 10%; left: 40%; clip-path: polygon(20% 0%, 80% 0%, 100% 30%, 80% 50%, 90% 80%, 50% 100%, 10% 80%, 0% 40%, 20% 20%); }
        .c-asia { width: 30%; height: 50%; top: 10%; left: 65%; clip-path: polygon(0% 0%, 80% 0%, 100% 40%, 90% 80%, 60% 100%, 20% 90%, 0% 50%); }
        .c-se-asia { width: 10%; height: 20%; top: 60%; left: 80%; clip-path: polygon(0% 0%, 60% 0%, 60% 40%, 100% 40%, 100% 100%, 40% 100%, 40% 60%, 0% 60%, 0% 0%); background: #66bb6a; }

        .map-pin { position: absolute; width: 12px; height: 12px; background: red; border: 2px solid white; border-radius: 0; transform: translate(-50%, -50%); cursor: pointer; z-index: 10; box-shadow: 2px 2px 0px black; }
        .map-pin.active { background: #FFD700; width: 18px; height: 18px; z-index: 20; animation: pulse 1s infinite; }
        .map-tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 2px 6px; font-size: 0.8rem; white-space: nowrap; pointer-events: none; display: none; z-index: 30; top: -30px; left: 50%; transform: translateX(-50%); border: 1px solid white; }
        .map-pin:hover .map-tooltip { display: block; }

        /* ANIMATIONS */
        .floater { position: absolute; font-size: 1.5rem; color: var(--accent); pointer-events: none; text-shadow: 1px 1px 0px white; animation: floatUp 0.8s ease-out forwards; z-index: 100; }
        .floater.crit { font-size: 2.5rem; color: gold; text-shadow: 2px 2px 0px black; }
        .bump-anim { animation: bumpAnim 0.15s ease-in-out; }
        @keyframes bumpAnim { 0% { transform: scale(1); } 50% { transform: scale(0.9); } 100% { transform: scale(1); } }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); } }
        @keyframes floatUp { 0%{transform:translateY(0);opacity:1;} 100%{transform:translateY(-80px);opacity:0;} }

        /* NEWS BAR */
        #news-bar { background: var(--news-bg); color: white; border-top: 4px solid black; height: 30px; display: flex; align-items: center; overflow: hidden; white-space: nowrap; flex-shrink: 0; position: relative; cursor: grab; }
        #news-bar:active { cursor: grabbing; }
        #news-label { background: var(--accent); padding: 0 10px; height: 100%; display: flex; align-items: center; font-weight: bold; font-size: 1.2rem; z-index: 10; position: absolute; left: 0; top: 0; }
        #news-track { display: flex; position: absolute; left: 80px; height: 100%; align-items: center; }
        .news-item { font-size: 1.2rem; padding-right: 40px; white-space: nowrap; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            #game-container { flex-direction: column; }
            .left-panel { flex: 1; min-height: 40%; min-width: 100%; padding: 5px; }
            .right-panel { flex: 1.5; height: auto; min-width: 100%; }
            #click-btn-container { width: 180px; height: 180px; }
            #click-btn { width: 140px; height: 140px; font-size: 4rem; }
            #dylan-sprite { margin-top: -60px; font-size: 2.5rem; } 
            #heart-sprite { margin-top: -80px; font-size: 2rem; }
            #resource-count { font-size: 3rem; margin-top: 0; }
            #resource-display { margin-top: 10px; margin-bottom: 10px; }
            .modal-box { padding: 15px; width: 95%; }
            .modal-box h1 { font-size: 2rem; }
            .pixel-map { width: 100%; aspect-ratio: 2/1; height: auto; }
            #cafe-scene { height: 120px; }
            #info-panel { height: 70px; }
            #info-icon-container { width: 40px; height: 40px; font-size: 2rem; }
            .bouncing-sprite { font-size: 1.5rem; }
        }

    </style>
</head>
<body>

    <!-- LANGUAGE SELECT -->
    <div id="language-overlay">
        <div class="modal-box">
            <h1>SELECT LANGUAGE</h1>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="pixel-btn" onclick="setLanguage('en')">ENGLISH</button>
                <button class="pixel-btn" onclick="setLanguage('hu')">MAGYAR</button>
                <button class="pixel-btn" onclick="setLanguage('nl')">NEDERLANDS</button>
                <button class="pixel-btn" onclick="setLanguage('vi')">TI·∫æNG VI·ªÜT</button>
            </div>
        </div>
    </div>

    <!-- INTRO -->
    <div id="intro-overlay">
        <div class="modal-box">
            <h1 id="intro-title"></h1>
            <p id="intro-text"></p>
            <button class="pixel-btn" onclick="showTutorial()" data-i18n="btn_start">START</button>
        </div>
    </div>

    <!-- TUTORIAL -->
    <div id="tutorial-overlay">
        <div class="modal-box">
            <h1 id="tut-title"></h1>
            <div style="text-align:left; font-size:1.4rem;">
                <p id="tut-step-1"></p>
                <p id="tut-step-2"></p>
                <p id="tut-step-3"></p>
            </div>
            <button class="pixel-btn" onclick="startGame()" data-i18n="btn_letsgo">LET'S GO!</button>
        </div>
    </div>

    <!-- MENU OVERLAY -->
    <div id="menu-overlay">
        <div class="modal-box">
            <h1 data-i18n="ui_menu">MENU</h1>
            <button class="pixel-btn" id="mute-btn-menu" onclick="toggleAudio()">üîä SOUND ON</button>
            <br>
            <button class="pixel-btn" onclick="toggleMap()" data-i18n="ui_map">üó∫Ô∏è MAP</button>
            <br>
            <button class="pixel-btn" onclick="toggleStats()" data-i18n="ui_stats">üìä STATS</button>
            <br>
            <button class="pixel-btn" onclick="replayIntro()" data-i18n="ui_replay">REPLAY INTRO</button>
            <div style="margin: 10px 0; border: 1px dashed #000; padding: 10px;">
                <p style="margin:0 0 5px 0; font-size:1rem;" data-i18n="ui_lang">LANGUAGE</p>
                <button class="pixel-btn small" onclick="setLanguage('en')">EN</button>
                <button class="pixel-btn small" onclick="setLanguage('hu')">HU</button>
                <button class="pixel-btn small" onclick="setLanguage('nl')">NL</button>
                <button class="pixel-btn small" onclick="setLanguage('vi')">VI</button>
            </div>
            <hr>
            <button class="pixel-btn" style="background:#555;" onclick="toggleMenu()" data-i18n="ui_resume">RESUME</button>
            <br><br>
            <button class="pixel-btn small" style="background:red;" onclick="showResetConfirm()" data-i18n="ui_reset">RESET SAVE</button>
        </div>
    </div>

    <!-- RESET CONFIRM OVERLAY -->
    <div id="reset-overlay">
        <div class="modal-box">
            <h2 data-i18n="reset_confirm">Are you sure?</h2>
            <p data-i18n="reset_desc">This will wipe your save.</p>
            <button class="pixel-btn" onclick="confirmReset()" data-i18n="btn_yes">YES</button>
            <button class="pixel-btn" onclick="closeReset()" data-i18n="btn_no">NO</button>
        </div>
    </div>

    <!-- MAP OVERLAY -->
    <div id="map-overlay">
        <div class="modal-box" style="width: 800px; max-width: 95%;">
            <h1 data-i18n="ui_worldmap">WORLD TOUR MAP</h1>
            <div class="pixel-map" id="map-container">
                <div class="continent c-americas"></div>
                <div class="continent c-eur-afr"></div>
                <div class="continent c-asia"></div>
                <div class="continent c-se-asia"></div>
                <!-- Pins via JS -->
            </div>
            <br>
            <button class="pixel-btn" onclick="toggleMap()" data-i18n="ui_close">CLOSE</button>
        </div>
    </div>

    <!-- NEWSPAPER OVERLAY -->
    <div id="newspaper-overlay">
        <div class="newspaper">
            <div class="news-close" onclick="closeNewspaper()">X</div>
            <div class="news-header">
                <div class="news-logo">KLDRNEWS2</div>
                <div class="news-sub" data-i18n="news_sub">THE MATCHA CHRONICLES</div>
            </div>
            <div class="news-headline" id="np-headline"></div>
            <div class="news-body" id="np-body"></div>
            <button class="pixel-btn small" onclick="closeNewspaper()" data-i18n="btn_readmore">READ MORE</button>
        </div>
    </div>

    <!-- STATS OVERLAY -->
    <div id="stats-overlay">
        <div class="modal-box">
            <h2 data-i18n="ui_stats_title">Caf√© Statistics</h2>
            <div id="stats-content"></div>
            <button class="pixel-btn" onclick="toggleStats()" data-i18n="ui_close">CLOSE</button>
        </div>
    </div>

    <!-- LEVEL UP POPUP -->
    <div id="location-popup">
        <div class="modal-box">
            <h2 id="loc-popup-title"></h2>
            <p id="loc-popup-desc"></p>
            <button class="pixel-btn" onclick="closeLocPopup()" data-i18n="btn_nice">NICE</button>
        </div>
    </div>

    <div id="game-container">
        
        <!-- LEFT PANEL -->
        <div class="left-panel">
            <button class="pixel-btn small" id="menu-btn" onclick="toggleMenu()" data-i18n="ui_menu">MENU</button>

            <div class="resource-display">
                <div id="resource-count">0</div>
                <div data-i18n="currency">MATCHAS</div>
                <div id="rps-display">0 / SEC</div>
                <div id="active-rps"></div>
            </div>
            
            <div id="click-btn-container">
                <div id="click-btn"></div>
                <div id="dylan-orbit-wrapper" class="orbit-wrapper">
                    <div id="dylan-sprite" class="orbiter-sprite">üë®üèæ‚Äçü¶±</div>
                </div>
                <div id="heart-orbit-wrapper" class="orbit-wrapper">
                    <div id="heart-sprite" class="orbiter-sprite">‚ù§Ô∏è</div>
                </div>
            </div>
            
            <div style="margin-top: auto; text-align: center; color: var(--text-color); width: 100%;">
                <p style="font-size: 1.2rem; margin: 0;" id="goal-text"></p>
                <div class="progress-container">
                    <div class="progress-fill" id="goal-progress"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="right-panel">
            <div id="cafe-scene">
                <div class="scene-label" onclick="toggleStats()" data-i18n="scene_label">HANI'S CAF√â FLOOR (STATS)</div>
                <div id="sprite-container"></div>
            </div>

            <div id="info-panel">
                <div id="info-icon-container">?</div>
                <div id="info-text">
                    <h3 id="info-title" data-i18n="welcome">Welcome</h3>
                    <p id="info-desc" data-i18n="hover_info">Hover over items to see details.</p>
                    <div id="info-cost"></div>
                </div>
            </div>

            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('buildings')" data-i18n="tab_buildings">Buildings</button>
                <button class="tab-btn" onclick="switchTab('upgrades')" data-i18n="tab_upgrades">Upgrades</button>
                <button class="tab-btn" onclick="switchTab('passport')" data-i18n="tab_passport">Passport</button>
            </div>

            <div id="tab-buildings" class="tab-content active"></div>
            <div id="tab-upgrades" class="tab-content">
                <div class="upgrades-grid" id="upgrades-list"></div>
                <p style="text-align:center; color:#777; margin-top:20px;" data-i18n="buy_upgrades">Buy upgrades to boost production!</p>
            </div>
            <div id="tab-passport" class="tab-content">
                <h3 data-i18n="curr_loc">Current Location</h3>
                <div id="passport-loc" style="font-size:1.5rem; margin-bottom:10px;">Hungary üá≠üá∫</div>
                <div id="passport-mult" style="color:var(--primary); font-weight:bold;">Multiplier: x1</div>
                <h3 style="margin-top:20px; border-top:2px solid #ccc; padding-top:10px;" data-i18n="passives">Active Passives</h3>
                <div id="passives-list"></div>
            </div>
        </div>
    </div>

    <div id="news-bar" onmousedown="pauseNews()" onmouseup="resumeNews()" onmouseleave="resumeNews()" ontouchstart="pauseNews()" ontouchend="resumeNews()">
        <div id="news-label" data-i18n="ui_news">NEWS</div>
        <div id="news-track"></div>
    </div>

    <script>
        /* --- TRANSLATION DATA --- */
        const LANG = {
            en: {
                intro_title: "Hani's Holiday Matcha",
                intro_text: "It's Christmas time! Hani wants to bring the warmth of REAL Matcha to the world. Grab the Legendary Whisk and start the journey!",
                tut_title: "HOW TO PLAY",
                tut_1: "1. CLICK the big Matcha.",
                tut_2: "2. BUY buildings & upgrades.",
                tut_3: "3. TRAVEL the world!",
                currency: "MATCHAS",
                tab_buildings: "Buildings",
                tab_upgrades: "Upgrades",
                tab_passport: "Passport",
                welcome: "Welcome",
                hover_info: "Hover over items for details.",
                buy_upgrades: "Buy upgrades to boost production!",
                curr_loc: "Current Location",
                passives: "Active Passives",
                goal_prefix: "NEXT GOAL:",
                goal_global: "GLOBAL DOMINATION!",
                ui_menu: "MENU", ui_map: "üó∫Ô∏è VIEW MAP", ui_worldmap: "WORLD TOUR MAP", ui_stats: "üìä STATISTICS", ui_stats_title: "Caf√© Statistics", ui_lang: "LANGUAGE", ui_resume: "RESUME", ui_reset: "RESET SAVE", ui_close: "CLOSE", ui_news: "NEWS",
                ui_replay: "REPLAY INTRO",
                btn_start: "START", btn_letsgo: "LET'S GO!", btn_nice: "NICE", btn_readmore: "READ MORE", btn_yes: "YES", btn_no: "NO",
                news_sub: "THE MATCHA CHRONICLES", scene_label: "HANI'S CAF√â FLOOR (STATS)", loc_new: "NEW COUNTRY!", loc_arrived: "You have arrived.", reset_confirm: "Are you sure?", reset_desc: "This will wipe your save.",

                b0_n: "Bamboo Whisk", b0_d: "Faster frothing.", b0_n_t2: "Robo-Arm Whisk", b0_d_t2: "Industrial frothing automation.", b0_n_t3: "Quantum Whisk", b0_d_t3: "Froths at sub-atomic levels.",
                b1_n: "Lili (Sister)", b1_d: "She helps out!", b1_n_t2: "Manager Lili", b1_d_t2: "She runs the place now.", b1_n_t3: "CEO Lili", b1_d_t3: "She runs the world now.",
                b2_n: "Plastic Stool", b2_d: "More seats!", b2_n_t2: "Velvet Sofa", b2_d_t2: "Luxury seating.", b2_n_t3: "Golden Throne", b2_d_t3: "Seating for royalty.",
                b3_n: "Delivery Fleet", b3_d: "Motorbikes everywhere.", b3_n_t2: "Matcha Drones", b3_d_t2: "Airborne tea delivery.", b3_n_t3: "Teleporters", b3_d_t3: "Instant tea transmission.",
                b4_n: "Da Lat Tea Hill", b4_d: "Fresh from the mountains.", b4_n_t2: "Bio-Plantation", b4_d_t2: "Genetically perfect leaves.", b4_n_t3: "Matcha Golem", b4_d_t3: "Living tea guardians.",
                b5_n: "Matcha Lab", b5_d: "Science of flavor.", b5_n_t2: "Flavor Reactor", b5_d_t2: "Atomic level taste.", b5_n_t3: "Taste Singularity", b5_d_t3: "Flavor so dense light can't escape.",
                b6_n: "Matcha NGO", b6_d: "Charity work for tea.", b6_n_t2: "World Peace Org", b6_d_t2: "Tea brings peace.", b6_n_t3: "Galactic Senate", b6_d_t3: "Universal harmony.",
                b7_n: "Spirit Portal", b7_d: "Summon the Matcha Gods.", b7_n_t2: "Reality Rift", b7_d_t2: "Tea from the 5th dimension.", b7_n_t3: "Big Bang Brewer", b7_d_t3: "Creating universes of tea.",

                loc_0: "Hungary", loc_w_0: "Christmas Market Budapest! Cold air, hot tea.",
                loc_1: "Spain", loc_w_1: "Hola! Hani serves Matcha Tapas now.",
                loc_2: "Netherlands", loc_w_2: "Amsterdam! Stroopwafels and Matcha.",
                loc_3: "UK", loc_w_3: "London Calling! Swap the Earl Grey for Matcha.",
                loc_4: "Guyana", loc_w_4: "Welcome to Guyana! The Land of Many Waters... and now Matcha!",
                loc_5: "Suriname", loc_w_5: "Suriname! Beautiful nature and powerful tea.",
                loc_6: "USA", loc_w_6: "USA! The land of opportunity and iced matcha lattes.",
                loc_7: "Vietnam", loc_w_7: "Home sweet home! The Ultimate HQ.",
                loc_8: "Matcha Earth", loc_w_8: "You have conquered the planet. The world is green.",

                u_condensed_milk: "Condensed Milk", u_condensed_milk_d: "Clicks x2",
                u_dylan: "Dylan (BF)", u_dylan_d: "Auto-Clicks every 10s",
                u_dylan_2: "Dylan's Training", u_dylan_2_d: "Dylan clicks 2s faster",
                u_dylan_3: "Dylan's Cardio", u_dylan_3_d: "Dylan clicks 2s faster",
                u_dylan_4: "Dylan's Espresso", u_dylan_4_d: "Dylan clicks 1.5s faster",
                u_dylan_5: "Dylan's Spirit", u_dylan_5_d: "Dylan clicks 1s faster",
                u_dylan_6: "Time Warp", u_dylan_6_d: "Dylan hits max speed (0.1s)",
                u_unending_love: "Unending Love", u_unending_love_d: "Double the love! 2nd Auto-Clicker.",
                u_blueberry: "Blueberry Mix", u_blueberry_d: "Whisks x2",
                u_spoon: "Matcha Spoon", u_spoon_d: "Click gains 5% of MPS",
                u_barni: "Barni (Artist)", u_barni_d: "Barni paints! Global +20%",
                u_lucky: "Uncle Lucky", u_lucky_d: "10% Chance for 2x Click",
                u_modeling: "Modeling Contract", u_modeling_d: "Lili is famous! Lili x2",
                u_vini: "Daily Call from Vini", u_vini_d: "Brotherly motivation! Global x1.3",
                u_naomi: "Naomi's Magic Ball", u_naomi_d: "Future is bright! +10% Crit Chance",
                u_richi: "Richi's Sprint", u_richi_d: "Track star delivery! Fleet x2",
                u_orsidia: "BFF Orsi & Dia", u_orsidia_d: "Besties support! Global x1.4",
                u_bao: "Bao's Discovery", u_bao_d: "Found the medal! Click Power x1.25",
                u_adri: "Adri's Peace", u_adri_d: "Reunited Guyana & Suriname! Global x2.0",
                u_cat: "Shop Cat", u_cat_d: "Cute! Global +10%",
                u_boss_woman: "Boss Woman", u_boss_woman_d: "Hani runs an NGO now. Global x1.5",
                u_fertilizer: "Organic Fertilizer", u_fertilizer_d: "Tea Hills x2 Production",
                u_nguyen: "All I Do Is Nguyen", u_nguyen_d: "Win win win! Global x1.5",
                u_trade_deal: "VN-JP Trade Deal", u_trade_deal_d: "Big Business! Global +50%",

                n_start_1: "Hani tries to put paprika in matcha. Hungarians are confused.",
                n_start_2: "Local Budapest resident: 'Is this soup?'",
                n_matchyar: "Breaking: Magyar now officially called 'Matchyar'.",
                n_spain_1: "Hani is dancing Flamenco with a whisk in hand.",
                n_spain_2: "Siesta time canceled, too much caffeine in the air.",
                n_nl_1: "Dutch news: Green tea stroopwafels are the new craze.",
                n_nl_2: "Amsterdam canal turns green... authorities suspect Hani.",
                n_uk_1: "The Queen has been spotted sipping Hani's Special Blend.",
                n_uk_2: "London fog is actually just matcha steam.",
                n_guyana: "Hani exploring the Kaieteur Falls with a cup of tea.",
                n_adri: "Adri has successfully negotiated a peace treaty using only Matcha.",
                n_suri_1: "Paramaribo market sold out of green powder.",
                n_suri_2: "Hani says Suriname reminds her of the good vibes.",
                n_richi: "Richi wins gold medal in Matcha Delivery Olympics.",
                n_vn_1: "Hani finally arrives in Vietnam! The tea is perfect.",
                n_vn_2: "Hanoi traffic stopped for giant tea parade.",
                n_dylan: "Dylan has drank {n} cups of matcha. He is vibrating.",
                n_lili: "Breaking: Lili has evolved. She cloned herself to cover the night shift.",
                n_lili_2: "Customers confused seeing multiple Lilis at once. 'I'm just fast', she claims.",
                n_lucky: "Uncle Lucky says: 'Put it all on Green!'",
                n_naomi: "Naomi predicts high profits today.",
                n_orsi: "Orsi & Dia are posting 5-star reviews everywhere.",
                n_cat: "Shop cat accidentally orders 5000kg of fish.",
                n_bao: "Bao found a shiny thing. It was the lost medal!",
                n_boss: "Hani elected president of the Matcha NGO.",
                n_sci: "Scientists say the world is 70% water, 30% matcha.",
                n_blackhole: "Hani accidentally creates a black hole of flavor. It tastes grassy.",
                n_save: "Reality creates a save point because the matcha is too good.",
                n_aliens: "Aliens land, ask for 'The Green Stuff'.",
                n_earth: "EARTH IS GREEN.",
                n_dylan_10: "Dylan's hands are shaking from matcha overload.",
                n_dylan_100: "Dylan can see time.",
                n_dylan_1k: "Dylan has ascended beyond the need for sleep.",
                n_dylan_10k: "Dylan vibrates at the frequency of the universe.",
                n_dylan_100k: "Dylan is no longer man, but pure energy.",
                n_dylan_1m: "Dylan has become the Matcha Singularity.",
                n_dylan_10m: "Dylan has surpassed 10,000,000 cups. He is now a constellation.",
                n_gen_1: "Green clouds spotted over the city.",
                n_gen_2: "Breaking: Coffee beans go on strike.",
                n_gen_3: "Matcha is the new water.",
                n_gen_4: "Local man claims he turned green after drinking too much matcha.",
                n_gen_5: "Hani's cafe wins 'Greenest Place on Earth' award."
            },
            hu: {
                intro_title: "Hani √únnepi Matcha K√°v√©z√≥ja", intro_text: "Kar√°csony van Budapesten! Hani igazi Match√°t akar adni a vil√°gnak. Fogd a Legend√°s Habver≈ët √©s indulj!",
                tut_title: "HOGYAN J√ÅTSSZ", tut_1: "1. KATTINTS a nagy Match√°ra.", tut_2: "2. V√ÅS√ÅROLJ fejleszt√©seket.", tut_3: "3. UTAZD be a vil√°got!",
                currency: "MATCHA", tab_buildings: "√âp√ºletek", tab_upgrades: "Extr√°k", tab_passport: "√ötlev√©l", welcome: "√údv√∂z√∂llek",
                hover_info: "Vidd r√° az egeret a r√©szletek√©rt.", buy_upgrades: "Vegy√©l extr√°kat a termel√©shez!", curr_loc: "Jelenlegi Hely",
                passives: "Akt√≠v Hat√°sok", goal_prefix: "K√ñVETKEZ≈ê C√âL:", goal_global: "VIL√ÅGURALOM!", ui_menu: "MEN√ú", ui_map: "T√âRK√âP", ui_stats: "STATISZTIKA", ui_lang: "NYELV", ui_resume: "FOLYTAT√ÅS", ui_reset: "MENT√âS T√ñRL√âSE", ui_close: "BEZ√ÅR", ui_news: "H√çREK", ui_worldmap: "VIL√ÅG T√âRK√âP", ui_stats_title: "K√°v√©z√≥ Statisztik√°k", ui_replay: "INTRO √öJRAJ√ÅTSZ√ÅSA",
                btn_start: "IND√çT√ÅS", btn_letsgo: "GYER√úNK!", btn_nice: "SZUPER", btn_readmore: "OLVASS TOV√ÅBB", btn_yes: "IGEN", btn_no: "NEM", news_sub: "A MATCHA KR√ìNIK√ÅK", scene_label: "HANI K√ÅV√âZ√ìJA (STATS)", loc_new: "√öJ ORSZ√ÅG!", loc_arrived: "Meg√©rkezt√©l.",
                reset_confirm: "Biztos vagy benne?", reset_desc: "Minden eddigi halad√°s t√∂rl≈ëdik.",

                b0_n: "Bambusz Habver≈ë", b0_d: "Gyorsabb habos√≠t√°s.", b0_n_t2: "Robotkar", b0_d_t2: "Ipari habos√≠t√°s.", b0_n_t3: "Kvantum Habver≈ë", b0_d_t3: "Szubatomi habos√≠t√°s.",
                b1_n: "Lili (Hugica)", b1_d: "Seg√≠t neked!", b1_n_t2: "Menedzser Lili", b1_d_t2: "≈ê vezeti a helyet.", b1_n_t3: "CEO Lili", b1_d_t3: "≈ê vezeti a vil√°got.",
                b2_n: "M≈±anyag Sz√©k", b2_d: "T√∂bb √ºl≈ëhely!", b2_n_t2: "B√°rsony Kanap√©", b2_d_t2: "Luxus √ºl≈ëhely.", b2_n_t3: "Arany Tr√≥n", b2_d_t3: "Kir√°lyi √ºl≈ëhely.",
                b3_n: "Fut√°r Flotta", b3_d: "Motorok mindenhol.", b3_n_t2: "Matcha Dr√≥nok", b3_d_t2: "L√©gi sz√°ll√≠t√°s.", b3_n_t3: "Teleportok", b3_d_t3: "Azonnali tea √°tvitel.",
                b4_n: "Da Lat Tea Hegy", b4_d: "Friss a hegyekb≈ël.", b4_n_t2: "Bio-√últetv√©ny", b4_d_t2: "Genetikailag t√∂k√©letes.", b4_n_t3: "Matcha G√≥lem", b4_d_t3: "√âl≈ë tea ≈ërz≈ëk.",
                b5_n: "Matcha Labor", b5_d: "Az √≠z tudom√°nya.", b5_n_t2: "√çz Reaktor", b5_d_t2: "Atomi szint≈± √≠z.", b5_n_t3: "√çz Szingularit√°s", b5_d_t3: "Olyan s≈±r≈± √≠z, hogy a f√©ny sem jut ki.",
                b6_n: "Matcha NGO", b6_d: "J√≥t√©konys√°gi tea.", b6_n_t2: "Vil√°gb√©ke Szervezet", b6_d_t2: "A tea b√©k√©t hoz.", b6_n_t3: "Galaktikus Szen√°tus", b6_d_t3: "Univerz√°lis harm√≥nia.",
                b7_n: "Szellem Port√°l", b7_d: "Id√©zd meg a Matcha Isteneket.", b7_n_t2: "Val√≥s√°g Hasad√©k", b7_d_t2: "Tea az 5. dimenzi√≥b√≥l.", b7_n_t3: "≈êsrobban√°s F≈ëz≈ë", b7_d_t3: "Tea univerzumok teremt√©se.",

                loc_0: "Magyarorsz√°g", loc_w_0: "Budapesti Kar√°csonyi V√°s√°r! Hideg leveg≈ë, forr√≥ tea.",
                loc_1: "Spanyolorsz√°g", loc_w_1: "Hola! Hani most Matcha Tapast szolg√°l fel.",
                loc_2: "Hollandia", loc_w_2: "Amszterdam! Stroopwafel √©s Matcha.",
                loc_3: "Egyes√ºlt Kir√°lys√°g", loc_w_3: "London h√≠v! Cser√©ld az Earl Greyt Match√°ra.",
                loc_4: "Guyana", loc_w_4: "√údv Guyan√°ban! A sok v√≠z f√∂ldje... √©s most m√°r a Match√°√©!",
                loc_5: "Suriname", loc_w_5: "Suriname! Gy√∂ny√∂r≈± term√©szet √©s er≈ës tea.",
                loc_6: "USA", loc_w_6: "USA! A lehet≈ës√©gek √©s a jeges matcha latt√©k f√∂ldje.",
                loc_7: "Vietnam", loc_w_7: "Otthon, √©des otthon! A V√©gs≈ë F≈ëhadisz√°ll√°s.",
                loc_8: "Matcha F√∂ld", loc_w_8: "Megh√≥d√≠tottad a bolyg√≥t. A vil√°g z√∂ld.",

                u_condensed_milk: "S≈±r√≠tett Tej", u_condensed_milk_d: "Kattint√°s x2",
                u_dylan: "Dylan (Bar√°t)", u_dylan_d: "Auto-Klikk 10mp-enk√©nt",
                u_spoon: "Matcha Kan√°l", u_spoon_d: "Kattint√°s az MPS 5%-√°t adja",
                u_barni: "Barni (M≈±v√©sz)", u_barni_d: "Barni fest! Termel√©s +20%",
                u_lucky: "Szerencs√©s B√°csi", u_lucky_d: "10% es√©ly 2x kattint√°sra",
                u_modeling: "Modell Szerz≈ëd√©s", u_modeling_d: "Lili h√≠res! Lili x2",
                u_vini: "Napi H√≠v√°s Vinit≈ël", u_vini_d: "Testv√©ri motiv√°ci√≥! x1.3",
                u_naomi: "Naomi Var√°zsg√∂mbje", u_naomi_d: "F√©nyes j√∂v≈ë! +10% Kritikus",
                u_richi: "Richi Sprintje", u_richi_d: "Fut√°r szt√°r! Flotta x2",
                u_orsidia: "Orsi & Dia", u_orsidia_d: "Bar√°tn≈ëk t√°mogat√°sa! x1.4",
                u_bao: "Bao Felfedez√©se", u_bao_d: "Meglett az √©rem! Kattint√°s x1.25",
                u_adri: "Adri B√©k√©je", u_adri_d: "Egyes√≠tette Guyan√°t & Suriname-ot! x2.0",
                u_cat: "Bolti Macska", u_cat_d: "Cuki! x1.1",
                u_boss_woman: "F≈ën√∂kasszony", u_boss_woman_d: "Hani NGO-t vezet. x1.5",
                u_fertilizer: "Bio Tr√°gya", u_fertilizer_d: "Tea Hegy x2",
                u_nguyen: "Csak A Gy≈ëzelem", u_nguyen_d: "Nyer√©s! x1.5",
                u_trade_deal: "VN-JP Kereskedelem", u_trade_deal_d: "Nagy √úzlet! x1.5",

                n_start_1: "Hani paprik√°t tesz a match√°ba. A magyarok zavartak.",
                n_start_2: "Budapesti lakos: 'Ez leves?'",
                n_matchyar: "Friss h√≠r: Magyarorsz√°g √∫j neve 'Matchyarorsz√°g'.",
                n_spain_1: "Hani Flamenc√≥t t√°ncol habver≈ëvel a k√©zben.",
                n_spain_2: "Szieszta t√∂r√∂lve, t√∫l sok a koffein.",
                n_nl_1: "Holland h√≠rek: A z√∂ld tea stroopwafel az √∫j ≈ër√ºlet.",
                n_nl_2: "Amszterdam csatorn√°i z√∂ldek... Hani gyan√∫s.",
                n_uk_1: "A Kir√°lyn≈ët l√°tt√°k Hani te√°j√°t inni.",
                n_uk_2: "A londoni k√∂d val√≥j√°ban matcha g≈ëz.",
                n_guyana: "Hani a Kaieteur-v√≠zes√©sn√©l te√°zik.",
                n_adri: "Adri b√©keszerz≈ëd√©st k√∂t√∂tt match√°val.",
                n_suri_1: "Paramaribo piaca kifogyott a z√∂ld porb√≥l.",
                n_suri_2: "Hani szerint Suriname a j√≥ hangulat haz√°ja.",
                n_richi: "Richi arany√©rmet nyert Matcha Fut√°r Olimpi√°n.",
                n_vn_1: "Hani v√©gre meg√©rkezett Vietn√°mba! A tea t√∂k√©letes.",
                n_vn_2: "Hanoi forgalma le√°llt az √≥ri√°s tea par√°d√© miatt.",
                n_lili: "Lili fejl≈ëd√∂tt. Kl√≥nozta mag√°t az √©jszakai m≈±szakra.",
                n_lili_2: "Vev≈ëk zavartak a sok Lilit≈ël. 'Csak gyors vagyok' - mondja.",
                n_lucky: "Szerencs√©s B√°csi: 'Tegy√©l mindent a Z√∂ldre!'",
                n_cat: "A macska v√©letlen√ºl rendelt 5000kg halat.",
                n_bao: "Bao tal√°lt valamit. A medal volt az!",
                n_boss: "Hanit megv√°lasztott√°k a Matcha NGO eln√∂k√©nek.",
                n_sci: "A tud√≥sok szerint a vil√°g 70% v√≠z, 30% matcha.",
                n_blackhole: "Hani v√©letlen√ºl l√©trehozott egy √≠z fekete lyukat.",
                n_save: "A val√≥s√°g ment√©si pontot k√©sz√≠t, mert t√∫l j√≥ a tea.",
                n_aliens: "≈∞rl√©nyek sz√°lltak le, a 'Z√∂ld Cuccot' k√©rik.",
                n_earth: "A F√ñLD Z√ñLD."
            },
            nl: {
                intro_title: "Hani's Kerst Matcha", intro_text: "Het is Kerstmis! Hani wil de wereld verwarmen met ECHTE Matcha. Pak de Legendarische Garde en begin!",
                tut_title: "HOE TE SPELEN", tut_1: "1. KLIK op de Matcha.", tut_2: "2. KOOP gebouwen & upgrades.", tut_3: "3. REIS de wereld rond!",
                currency: "MATCHA'S", tab_buildings: "Gebouwen", tab_upgrades: "Upgrades", tab_passport: "Paspoort", welcome: "Welkom",
                hover_info: "Beweeg over items voor details.", buy_upgrades: "Koop upgrades voor meer productie!", curr_loc: "Huidige Locatie",
                passives: "Actieve Passives", goal_prefix: "VOLGEND DOEL:", goal_global: "WERELD DOMINATIE!", ui_menu: "MENU", ui_map: "KAART", ui_stats: "STATISTIEKEN", ui_lang: "TAAL", ui_resume: "DOORGAAN", ui_reset: "RESETTEN", ui_close: "SLUITEN", ui_news: "NIEUWS", ui_worldmap: "WERELD KAART", ui_stats_title: "Caf√© Statistieken", ui_replay: "INTRO OPNIEUW",
                btn_start: "START", btn_letsgo: "GAAN!", btn_nice: "LEUK", btn_readmore: "LEES MEER", btn_yes: "JA", btn_no: "NEE", news_sub: "DE MATCHA KRONIEKEN", scene_label: "HANI'S CAF√â VLOER (STATS)", loc_new: "NIEUW LAND!", loc_arrived: "Je bent aangekomen.",
                reset_confirm: "Weet je het zeker?", reset_desc: "Dit wist je voortgang.",
                
                b0_n: "Bamboe Garde", b0_d: "Sneller kloppen.", b0_n_t2: "Robo-Arm", b0_d_t2: "Industri√´le automatisering.", b0_n_t3: "Kwantum Garde", b0_d_t3: "Kloppen op subatomair niveau.",
                b1_n: "Lili (Zus)", b1_d: "Ze helpt mee!", b1_n_t2: "Manager Lili", b1_d_t2: "Ze runt de tent.", b1_n_t3: "CEO Lili", b1_d_t3: "Ze runt de wereld.",
                b2_n: "Plastic Stoel", b2_d: "Meer zitplaatsen!", b2_n_t2: "Fluwelen Bank", b2_d_t2: "Luxe zitplaatsen.", b2_n_t3: "Gouden Troon", b2_d_t3: "Zitplaats voor koningen.",
                b3_n: "Bezorgvloot", b3_d: "Overal motors.", b3_n_t2: "Matcha Drones", b3_d_t2: "Thee via de lucht.", b3_n_t3: "Teleporters", b3_d_t3: "Directe thee transmissie.",
                b4_n: "Da Lat Theeberg", b4_d: "Vers uit de bergen.", b4_n_t2: "Bio-Plantage", b4_d_t2: "Genetisch perfect.", b4_n_t3: "Matcha Golem", b4_d_t3: "Levende thee bewakers.",
                b5_n: "Matcha Lab", b5_d: "Smaakwetenschap.", b5_n_t2: "Smaak Reactor", b5_d_t2: "Atoom niveau smaak.", b5_n_t3: "Smaak Singulariteit", b5_d_t3: "Smaak zo dicht dat licht niet ontsnapt.",
                b6_n: "Matcha NGO", b6_d: "Goede doelen thee.", b6_n_t2: "Wereld Vrede Org", b6_d_t2: "Thee brengt vrede.", b6_n_t3: "Galactische Senaat", b6_d_t3: "Universele harmonie.",
                b7_n: "Geesten Portaal", b7_d: "Roep de Matcha Goden.", b7_n_t2: "Realiteit Scheur", b7_d_t2: "Thee uit de 5e dimensie.", b7_n_t3: "Oerknal Brouwer", b7_d_t3: "Thee universums maken.",

                loc_0: "Hongarije", loc_w_0: "Kerstmarkt Boedapest! Koude lucht, hete thee.",
                loc_1: "Spanje", loc_w_1: "Hola! Hani serveert nu Matcha Tapas.",
                loc_2: "Nederland", loc_w_2: "Amsterdam! Stroopwafels en Matcha.",
                loc_3: "VK", loc_w_3: "Londen roept! Ruil Earl Grey voor Matcha.",
                loc_4: "Guyana", loc_w_4: "Welkom in Guyana! Land van veel water... en nu Matcha!",
                loc_5: "Suriname", loc_w_5: "Suriname! Prachtige natuur en krachtige thee.",
                loc_6: "VS", loc_w_6: "VS! Land van kansen en ijskoude matcha lattes.",
                loc_7: "Vietnam", loc_w_7: "Oost west, thuis best! Het Ultieme Hoofdkwartier.",
                loc_8: "Matcha Aarde", loc_w_8: "Je hebt de planeet veroverd. De wereld is groen.",

                u_condensed_milk: "Gecondenseerde Melk", u_condensed_milk_d: "Kliks x2",
                u_dylan: "Dylan (Vriend)", u_dylan_d: "Auto-Klik elke 10s",
                u_spoon: "Matcha Lepel", u_spoon_d: "Klik geeft 5% van MPS",
                u_barni: "Barni (Artiest)", u_barni_d: "Barni schildert! Global +20%",
                u_lucky: "Oom Lucky", u_lucky_d: "10% Kans op 2x Klik",
                u_modeling: "Modellencontract", u_modeling_d: "Lili is beroemd! Lili x2",
                u_vini: "Dagelijks belletje Vini", u_vini_d: "Broederlijke motivatie! x1.3",
                u_naomi: "Naomi's Toverbal", u_naomi_d: "Toekomst is helder! +10% Crit",
                u_richi: "Richi's Sprint", u_richi_d: "Snelle bezorging! Vloot x2",
                u_orsidia: "BFF Orsi & Dia", u_orsidia_d: "Besties steun! x1.4",
                u_bao: "Bao's Ontdekking", u_bao_d: "Medaille gevonden! Klik x1.25",
                u_adri: "Adri's Vrede", u_adri_d: "Guyana & Suriname herenigd! x2.0",
                u_cat: "Winkel Kat", u_cat_d: "Schattig! x1.1",
                u_boss_woman: "Baas Vrouw", u_boss_woman_d: "Hani runt een NGO. x1.5",
                u_fertilizer: "Bio Mest", u_fertilizer_d: "Theeberg x2",
                u_nguyen: "Alles is Nguyen", u_nguyen_d: "Winnen! x1.5",
                u_trade_deal: "VN-JP Handel", u_trade_deal_d: "Grote Zaken! x1.5",

                n_start_1: "Hani doet paprika in de matcha. Hongaren in de war.",
                n_start_2: "Lokale bewoner: 'Is dit soep?'",
                n_matchyar: "Breaking: Hongarije heet nu 'Matcharije'.",
                n_spain_1: "Hani danst Flamenco met een garde.",
                n_spain_2: "Si√´sta afgelast, te veel cafe√Øne.",
                n_nl_1: "Nederlands nieuws: Groene thee stroopwafels zijn de nieuwe rage.",
                n_nl_2: "Amsterdams kanaal kleurt groen... Hani verdacht.",
                n_uk_1: "De Koningin gespot met Hani's Speciale Mix.",
                n_uk_2: "Londense mist is eigenlijk matcha stoom.",
                n_guyana: "Hani verkent Kaieteur watervallen met thee.",
                n_adri: "Adri onderhandelt vredesverdrag met matcha.",
                n_suri_1: "Paramaribo markt uitverkocht van groen poeder.",
                n_suri_2: "Hani zegt dat Suriname goede vibes heeft.",
                n_richi: "Richi wint goud op Matcha Bezorg Olympische Spelen.",
                n_vn_1: "Hani eindelijk in Vietnam! De thee is perfect.",
                n_vn_2: "Hanoi verkeer stopt voor gigantische theeparade.",
                n_lili: "Lili is ge√´volueerd. Ze heeft zichzelf gekloond.",
                n_lucky: "Oom Lucky zegt: 'Alles op Groen!'",
                n_cat: "Winkelkat bestelt per ongeluk 5000kg vis.",
                n_bao: "Bao vond iets glimmends. Het was de medaille!",
                n_sci: "Wetenschappers: wereld is 70% water, 30% matcha.",
                n_blackhole: "Hani maakt per ongeluk een smaak zwart gat.",
                n_save: "De realiteit maakt een opslagpunt.",
                n_aliens: "Aliens landen, vragen om 'Het Groene Spul'.",
                n_earth: "AARDE IS GROEN."
            },
            vi: {
                intro_title: "Hani's Holiday Matcha", intro_text: "Gi√°ng sinh ƒë√£ ƒë·∫øn! Hani mu·ªën mang Matcha TH·∫¨T ƒë·∫øn v·ªõi th·∫ø gi·ªõi. C·∫ßm l·∫•y c√¢y ƒë√°nh tr√† huy·ªÅn tho·∫°i v√† b·∫Øt ƒë·∫ßu h√†nh tr√¨nh!",
                tut_title: "C√ÅCH CH∆†I", tut_1: "1. NH·∫§N v√†o ly Matcha.", tut_2: "2. MUA thi·∫øt b·ªã & n√¢ng c·∫•p.", tut_3: "3. DU L·ªäCH v√≤ng quanh th·∫ø gi·ªõi!",
                currency: "MATCHA", tab_buildings: "C·ª≠a h√†ng", tab_upgrades: "N√¢ng c·∫•p", tab_passport: "H·ªô chi·∫øu", welcome: "Ch√†o m·ª´ng",
                hover_info: "Di chu·ªôt ƒë·ªÉ xem chi ti·∫øt.", buy_upgrades: "Mua n√¢ng c·∫•p ƒë·ªÉ tƒÉng t·ªëc!", curr_loc: "V·ªã tr√≠ hi·ªán t·∫°i",
                passives: "Hi·ªáu ·ª©ng", goal_prefix: "M·ª§C TI√äU:", goal_global: "TH·ªêNG TR·ªä TO√ÄN C·∫¶U!", ui_menu: "MENU", ui_map: "B·∫¢N ƒê·ªí", ui_stats: "TH·ªêNG K√ä", ui_lang: "NG√îN NG·ªÆ", ui_resume: "TI·∫æP T·ª§C", ui_reset: "X√ìA SAVE", ui_close: "ƒê√ìNG", ui_news: "TIN T·ª®C", ui_worldmap: "B·∫¢N ƒê·ªí TH·∫æ GI·ªöI", ui_stats_title: "Th·ªëng k√™", ui_replay: "XEM L·∫†I INTRO",
                btn_start: "B·∫ÆT ƒê·∫¶U", btn_letsgo: "ƒêI TH√îI!", btn_nice: "TUY·ªÜT", btn_readmore: "ƒê·ªåC TH√äM", btn_yes: "C√ì", btn_no: "KH√îNG", news_sub: "NH·∫¨T K√ù MATCHA", scene_label: "S√ÄN CAF√â (TH·ªêNG K√ä)", loc_new: "QU·ªêC GIA M·ªöI!", loc_arrived: "B·∫°n ƒë√£ ƒë·∫øn n∆°i.",
                reset_confirm: "B·∫°n c√≥ ch·∫Øc kh√¥ng?", reset_desc: "D·ªØ li·ªáu s·∫Ω b·ªã x√≥a.",

                b0_n: "C√¢y ƒë√°nh tr√†", b0_d: "ƒê√°nh nhanh h∆°n.", b0_n_t2: "Tay Robot", b0_d_t2: "T·ª± ƒë·ªông h√≥a c√¥ng nghi·ªáp.", b0_n_t3: "ƒê√°nh L∆∞·ª£ng T·ª≠", b0_d_t3: "C·∫•p ƒë·ªô h·∫° nguy√™n t·ª≠.",
                b1_n: "Lili (Em g√°i)", b1_d: "Em ·∫•y gi√∫p m·ªôt tay!", b1_n_t2: "Qu·∫£n l√Ω Lili", b1_d_t2: "Em ·∫•y qu·∫£n l√Ω qu√°n.", b1_n_t3: "CEO Lili", b1_d_t3: "Em ·∫•y qu·∫£n l√Ω th·∫ø gi·ªõi.",
                b2_n: "Gh·∫ø Nh·ª±a", b2_d: "Th√™m ch·ªó ng·ªìi!", b2_n_t2: "Sofa Nhung", b2_d_t2: "Ch·ªó ng·ªìi sang tr·ªçng.", b2_n_t3: "Ngai V√†ng", b2_d_t3: "Gh·∫ø cho ho√†ng gia.",
                b3_n: "ƒê·ªôi Giao H√†ng", b3_d: "Xe m√°y kh·∫Øp n∆°i.", b3_n_t2: "Flycam Matcha", b3_d_t2: "Giao h√†ng tr√™n kh√¥ng.", b3_n_t3: "D·ªãch Chuy·ªÉn", b3_d_t3: "Giao tr√† t·ª©c th√¨.",
                b4_n: "ƒê·ªìi Ch√® ƒê√† L·∫°t", b4_d: "T∆∞∆°i t·ª´ tr√™n n√∫i.", b4_n_t2: "ƒê·ªìn ƒêi·ªÅn Bio", b4_d_t2: "L√° tr√† ho√†n h·∫£o.", b4_n_t3: "Ng∆∞·ªùi ƒê√° Matcha", b4_d_t3: "V·ªá th·∫ßn tr√†.",
                b5_n: "Ph√≤ng Lab", b5_d: "Khoa h·ªçc v·ªã gi√°c.", b5_n_t2: "L√≤ Ph·∫£n ·ª®ng", b5_d_t2: "V·ªã c·∫•p nguy√™n t·ª≠.", b5_n_t3: "ƒêi·ªÉm K·ª≥ D·ªã", b5_d_t3: "V·ªã ƒë·∫≠m ƒë·∫∑c √°nh s√°ng kh√¥ng tho√°t ƒë∆∞·ª£c.",
                b6_n: "Matcha NGO", b6_d: "T·ª´ thi·ªán tr√†.", b6_n_t2: "H√≤a B√¨nh TG", b6_d_t2: "Tr√† mang l·∫°i h√≤a b√¨nh.", b6_n_t3: "Th∆∞·ª£ng Vi·ªán", b6_d_t3: "H√≤a h·ª£p v≈© tr·ª•.",
                b7_n: "C·ªïng Linh H·ªìn", b7_d: "Tri·ªáu h·ªìi Th·∫ßn Tr√†.", b7_n_t2: "Khe N·ª©t", b7_d_t2: "Tr√† t·ª´ chi·ªÅu kh√¥ng gian th·ª© 5.", b7_n_t3: "Big Bang", b7_d_t3: "T·∫°o ra v≈© tr·ª• tr√†.",

                loc_0: "Hungary", loc_w_0: "Ch·ª£ Gi√°ng Sinh Budapest! L·∫°nh nh∆∞ng tr√† n√≥ng.",
                loc_1: "T√¢y Ban Nha", loc_w_1: "Hola! Hani ph·ª•c v·ª• Matcha Tapas.",
                loc_2: "H√† Lan", loc_w_2: "Amsterdam! B√°nh k·∫πp v√† Matcha.",
                loc_3: "Anh", loc_w_3: "London g·ªçi! ƒê·ªïi tr√† Earl Grey l·∫•y Matcha.",
                loc_4: "Guyana", loc_w_4: "Ch√†o m·ª´ng ƒë·∫øn Guyana! X·ª© s·ªü nhi·ªÅu n∆∞·ªõc... v√† gi·ªù l√† Matcha!",
                loc_5: "Suriname", loc_w_5: "Suriname! Thi√™n nhi√™n ƒë·∫πp v√† tr√† m·∫°nh.",
                loc_6: "M·ªπ", loc_w_6: "M·ªπ! Mi·ªÅn ƒë·∫•t h·ª©a v√† matcha latte ƒë√°.",
                loc_7: "Vi·ªát Nam", loc_w_7: "V·ªÅ nh√† r·ªìi! Tr·ª• s·ªü ch√≠nh Matcha.",
                loc_8: "Tr√°i ƒê·∫•t Matcha", loc_w_8: "B·∫°n ƒë√£ chinh ph·ª•c h√†nh tinh. Th·∫ø gi·ªõi m√†u xanh.",

                u_condensed_milk: "S·ªØa √îng Th·ªç", u_condensed_milk_d: "Nh·∫•n x2",
                u_dylan: "Dylan (B·∫°n trai)", u_dylan_d: "T·ª± ƒë·ªông nh·∫•n m·ªói 10s",
                u_spoon: "Th√¨a Matcha", u_spoon_d: "Nh·∫•n ƒë∆∞·ª£c 5% MPS",
                u_barni: "Barni (H·ªça sƒ©)", u_barni_d: "Barni v·∫Ω! To√†n c·∫ßu +20%",
                u_lucky: "Ch√∫ Lucky", u_lucky_d: "10% c∆° h·ªôi nh·∫•n x2",
                u_modeling: "H·ª£p ƒê·ªìng M·∫´u", u_modeling_d: "Lili n·ªïi ti·∫øng! Lili x2",
                u_vini: "Vini G·ªçi ƒêi·ªán", u_vini_d: "ƒê·ªông l·ª±c anh em! x1.3",
                u_naomi: "Qu·∫£ C·∫ßu Naomi", u_naomi_d: "T∆∞∆°ng lai s√°ng! +10% Ch√≠ m·∫°ng",
                u_richi: "Richi Ch·∫°y Nhanh", u_richi_d: "Giao h√†ng si√™u t·ªëc! ƒê·ªôi xe x2",
                u_orsidia: "BFF Orsi & Dia", u_orsidia_d: "B·∫°n th√¢n ·ªßng h·ªô! x1.4",
                u_bao: "Bao T√¨m Th·∫•y", u_bao_d: "T√¨m th·∫•y huy ch∆∞∆°ng! Nh·∫•n x1.25",
                u_adri: "H√≤a B√¨nh Adri", u_adri_d: "H√†n g·∫Øn Guyana & Suriname! x2.0",
                u_cat: "M√®o C·ª≠a H√†ng", u_cat_d: "D·ªÖ th∆∞∆°ng! x1.1",
                u_boss_woman: "N·ªØ Ch·ªß T·ªãch", u_boss_woman_d: "Hani ƒëi·ªÅu h√†nh NGO. x1.5",
                u_fertilizer: "Ph√¢n B√≥n H·ªØu C∆°", u_fertilizer_d: "ƒê·ªìi Ch√® x2",
                u_nguyen: "Win Win Nguyen", u_nguyen_d: "Chi·∫øn th·∫Øng! x1.5",
                u_trade_deal: "Th∆∞∆°ng M·∫°i VN-JP", u_trade_deal_d: "L√†m ƒÉn l·ªõn! x1.5",

                n_start_1: "Hani th·ª≠ cho ·ªõt v√†o matcha. Ng∆∞·ªùi Hungary b·ªëi r·ªëi.",
                n_start_2: "D√¢n Budapest: 'ƒê√¢y l√† s√∫p √†?'",
                n_matchyar: "Tin n√≥ng: Hungary ƒë·ªïi t√™n th√†nh 'Matchyar'.",
                n_spain_1: "Hani nh·∫£y Flamenco v·ªõi c√¢y ƒë√°nh tr√†.",
                n_spain_2: "H·ªßy gi·ªù ngh·ªâ tr∆∞a, qu√° nhi·ªÅu caffeine trong kh√¥ng kh√≠.",
                n_nl_1: "Tin H√† Lan: B√°nh stroopwafel tr√† xanh l√† m·ªët m·ªõi.",
                n_nl_2: "K√™nh ƒë√†o Amsterdam chuy·ªÉn m√†u xanh... Hani b·ªã nghi ng·ªù.",
                n_uk_1: "N·ªØ ho√†ng b·ªã b·∫Øt g·∫∑p ƒëang u·ªëng tr√† c·ªßa Hani.",
                n_uk_2: "S∆∞∆°ng m√π London th·ª±c ra l√† h∆°i n∆∞·ªõc matcha.",
                n_guyana: "Hani th√°m hi·ªÉm th√°c Kaieteur v·ªõi ly tr√†.",
                n_adri: "Adri ƒë√†m ph√°n h√≤a b√¨nh th√†nh c√¥ng b·∫±ng matcha.",
                n_suri_1: "Ch·ª£ Paramaribo h·∫øt s·∫°ch b·ªôt xanh.",
                n_suri_2: "Hani n√≥i Suriname g·ª£i nh·ªõ nh·ªØng rung c·∫£m t·ªët ƒë·∫πp.",
                n_richi: "Richi gi√†nh huy ch∆∞∆°ng v√†ng Olympic Giao Tr√†.",
                n_vn_1: "Hani cu·ªëi c√πng c≈©ng ƒë·∫øn Vi·ªát Nam! Tr√† ngon tuy·ªát.",
                n_vn_2: "Giao th√¥ng H√† N·ªôi d·ª´ng l·∫°i v√¨ di·ªÖu h√†nh tr√† kh·ªïng l·ªì.",
                n_lili: "Lili ƒë√£ ti·∫øn h√≥a. C√¥ ·∫•y nh√¢n b·∫£n ƒë·ªÉ l√†m ca ƒë√™m.",
                n_lili_2: "Kh√°ch b·ªëi r·ªëi v√¨ th·∫•y nhi·ªÅu Lili. 'Em nhanh th√¥i' - c√¥ n√≥i.",
                n_lucky: "Ch√∫ Lucky b·∫£o: 'ƒê·∫∑t h·∫øt v√†o m√†u Xanh!'",
                n_cat: "M√®o v√¥ t√¨nh ƒë·∫∑t mua 5000kg c√°.",
                n_bao: "Bao t√¨m th·∫•y v·∫≠t s√°ng. ƒê√≥ l√† huy ch∆∞∆°ng b·ªã m·∫•t!",
                n_sci: "Khoa h·ªçc: th·∫ø gi·ªõi l√† 70% n∆∞·ªõc, 30% matcha.",
                n_blackhole: "Hani v√¥ t√¨nh t·∫°o ra h·ªë ƒëen h∆∞∆°ng v·ªã.",
                n_save: "Th·ª±c t·∫°i t·∫°o ƒëi·ªÉm l∆∞u v√¨ tr√† qu√° ngon.",
                n_aliens: "Ng∆∞·ªùi ngo√†i h√†nh tinh ƒë√°p xu·ªëng, h·ªèi xin 'Th·ª© M√†u Xanh'.",
                n_earth: "TR√ÅI ƒê·∫§T M√ÄU XANH."
            }
        };
        
        let currentLang = 'en';
        let gameStarted = false;

        function getText(key) {
            if (LANG[currentLang] && LANG[currentLang][key]) return LANG[currentLang][key];
            if (LANG['en'][key]) return LANG['en'][key];
            return key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            
            // Only hide lang select if game hasn't started
            if (!gameStarted && document.getElementById('language-overlay').style.display !== 'none') {
                document.getElementById('language-overlay').style.display = 'none';
                document.getElementById('intro-overlay').style.display = 'flex';
            }

            // Safe DOM updates
            const setTitle = (id, key) => { const el = document.getElementById(id); if(el) el.innerText = getText(key); };
            const setHTML = (id, key) => { const el = document.getElementById(id); if(el) el.innerHTML = getText(key).replace('\n', '<br>'); };
            
            setTitle('intro-title', 'intro_title');
            setHTML('intro-text', 'intro_text');
            setTitle('tut-title', 'tut_title');
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.innerText = getText(el.getAttribute('data-i18n'));
            });

            if(document.getElementById('tut-step-1')) {
                document.getElementById('tut-step-1').innerHTML = getText('tut_1');
                document.getElementById('tut-step-2').innerHTML = getText('tut_2');
                document.getElementById('tut-step-3').innerHTML = getText('tut_3');
            }

            // Force refresh of UI components
            updateUI();
            
            // Clear news track so new language news spawns immediately
            const newsTrack = document.getElementById('news-track');
            if(newsTrack) newsTrack.innerHTML = '';
            recentNews = []; 
            
            // Re-render shop to update building names
            renderShop();
        }

        function showTutorial() {
            document.getElementById('intro-overlay').style.display = 'none';
            document.getElementById('tutorial-overlay').style.display = 'flex';
        }

        function replayIntro() {
            document.getElementById('menu-overlay').style.display = 'none';
            document.getElementById('intro-overlay').style.display = 'flex';
            // Note: pressing Start/Lets Go here will just close overlays without re-init
        }
        
        function showResetConfirm() {
            document.getElementById('reset-overlay').style.display = 'flex';
            document.getElementById('menu-overlay').style.display = 'none';
        }
        
        function closeReset() {
            document.getElementById('reset-overlay').style.display = 'none';
            document.getElementById('menu-overlay').style.display = 'flex';
        }
        
        function confirmReset() {
            localStorage.removeItem('haniVibrantSave');
            location.reload();
        }

        /* --- CONFIG --- */
        const CONFIG = {
            fps: 30,
            locations: [
                { id: 0, name: "Hungary", flag: "üá≠üá∫", threshold: 0, multiplier: 1, colors: { bg: "#8f1e1e", pat: "#165b33", pri: "#165b33", acc: "#d4af37", txt: "#212121" }, music: [220, 246, 261, 293, 329, 349, 415, 440], coords: { top: '28%', left: '54%' } },
                { id: 1, name: "Spain", flag: "üá™üá∏", threshold: 500, multiplier: 1.5, colors: { bg: "#AA151B", pat: "#F1BF00", pri: "#F1BF00", acc: "#AA151B", txt: "#212121" }, music: [329, 349, 392, 415, 392, 349, 329, 293], coords: { top: '35%', left: '49%' } },
                { id: 2, name: "Netherlands", flag: "üá≥üá±", threshold: 2500, multiplier: 2, colors: { bg: "#F36C21", pat: "#21468B", pri: "#F36C21", acc: "#21468B", txt: "#212121" }, music: [261, 329, 392, 523, 392, 329, 261, 196], coords: { top: '25%', left: '51%' } },
                { id: 3, name: "UK", flag: "üá¨üáß", threshold: 15000, multiplier: 3, colors: { bg: "#012169", pat: "#C8102E", pri: "#012169", acc: "#C8102E", txt: "#FFFFFF" }, music: [392, 392, 440, 493, 392, 293, 392, 493], coords: { top: '24%', left: '49%' } },
                { id: 4, name: "Guyana", flag: "üá¨üáæ", threshold: 50000, multiplier: 4, colors: { bg: "#009E49", pat: "#FCD116", pri: "#CE1126", acc: "#000000", txt: "#212121" }, music: [261, 329, 392, 440, 392, 329, 293, 261], coords: { top: '55%', left: '25%' } },
                { id: 5, name: "Suriname", flag: "üá∏üá∑", threshold: 150000, multiplier: 4.5, colors: { bg: "#377E3F", pat: "#FFFFFF", pri: "#B40A2D", acc: "#ECC81D", txt: "#212121" }, music: [329, 392, 440, 523, 440, 392, 329, 261], coords: { top: '55%', left: '27%' } },
                { id: 6, name: "USA", flag: "üá∫üá∏", threshold: 500000, multiplier: 5, colors: { bg: "#3C3B6E", pat: "#B22234", pri: "#B22234", acc: "#FFFFFF", txt: "#FFFFFF" }, music: [261, 329, 392, 523, 659, 523, 392, 329], coords: { top: '30%', left: '15%' } },
                { id: 7, name: "Vietnam", flag: "üáªüá≥", threshold: 1500000, multiplier: 6, colors: { bg: "#ff007f", pat: "#ff4081", pri: "#00e676", acc: "#651fff", txt: "#212121" }, music: [261, 293, 349, 392, 440, 523], coords: { top: '45%', left: '72%' } },
                { id: 8, name: "Matcha Earth", flag: "üåç", threshold: 100000000, multiplier: 10, colors: { bg: "#000000", pat: "#00ff00", pri: "#00ff00", acc: "#ffffff", txt: "#00ff00" }, music: [523, 659, 784, 1046], coords: { top: '50%', left: '50%' } }
            ],
            buildings: [
                { id: 0, baseCost: 15, baseProd: 0.5, symbol: "ü•£", evolved: {symbol: "ü¶æ"}, evolved2: {symbol: "‚öõÔ∏è"} },
                { id: 1, baseCost: 100, baseProd: 4, symbol: "üë©üèª", anim: "sprite", evolved: {symbol: "üë©üèª‚Äçüíº"}, evolved2: {symbol: "üï¥Ô∏è"} },
                { id: 2, baseCost: 1100, baseProd: 12, symbol: "ü™ë", evolved: {symbol: "üõãÔ∏è"}, evolved2: {symbol: "üí∫"} },
                { id: 3, baseCost: 12000, baseProd: 47, symbol: "üõµ", anim: "sprite", evolved: {symbol: "üöÅ"}, evolved2: {symbol: "üö™"} },
                { id: 4, baseCost: 130000, baseProd: 260, symbol: "‚õ∞Ô∏è", anim: "sprite", evolved: {symbol: "üß¨"}, evolved2: {symbol: "üóø"} },
                { id: 5, baseCost: 1400000, baseProd: 1400, symbol: "üß™", anim: "sprite", evolved: {symbol: "‚ò¢Ô∏è"}, evolved2: {symbol: "üï≥Ô∏è"} },
                { id: 6, baseCost: 10000000, baseProd: 6000, symbol: "ü§ù", anim: "sprite", evolved: {symbol: "üïäÔ∏è"}, evolved2: {symbol: "üëΩ"} },
                { id: 7, baseCost: 50000000, baseProd: 15000, symbol: "üåÄ", anim: "sprite", evolved: {symbol: "üåå"}, evolved2: {symbol: "üí•"} }
            ],
            upgrades: [
                { id: 'condensed_milk', icon: "ü•õ", cost: 500, type: 'click_mult', value: 2, trigger: g => g.total >= 100 },
                { id: 'dylan', icon: "üë®üèæ‚Äçü¶±", cost: 250, type: 'special', value: 0, trigger: g => g.total >= 100, visual: "üë®üèæ‚Äçü¶±" },
                { id: 'dylan_2', icon: "üí™", cost: 5000, type: 'special', value: 0, trigger: g => g.loc >= 1 && g.upgrades.includes('dylan') }, 
                { id: 'dylan_3', icon: "üèÉüèæ", cost: 25000, type: 'special', value: 0, trigger: g => g.loc >= 2 && g.upgrades.includes('dylan_2') }, 
                { id: 'dylan_4', icon: "‚òï", cost: 100000, type: 'special', value: 0, trigger: g => g.loc >= 3 && g.upgrades.includes('dylan_3') }, 
                { id: 'dylan_5', icon: "üßòüèæ‚Äç‚ôÇÔ∏è", cost: 500000, type: 'special', value: 0, trigger: g => g.loc >= 4 && g.upgrades.includes('dylan_4') }, 
                { id: 'dylan_6', icon: "‚è≥", cost: 5000000, type: 'special', value: 0, trigger: g => g.loc >= 6 && g.upgrades.includes('dylan_5') }, 
                { id: 'unending_love', icon: "‚ù§Ô∏è", cost: 10000000, type: 'special', value: 0, trigger: g => g.loc >= 6, visual: "‚ù§Ô∏è" },
                { id: 'blueberry', icon: "ü´ê", cost: 2500, type: 'building_mult', bId: 0, value: 2, trigger: g => g.buildings[0] >= 10 },
                { id: 'spoon', icon: "ü•Ñ", cost: 5000, type: 'click_percent_mps', value: 0.05, trigger: g => g.total >= 2000 },
                { id: 'barni', icon: "üë®üèº‚Äçüé®", cost: 5000, type: 'global_mult', value: 1.2, trigger: g => g.total >= 2000, visual: "üë®üèº‚Äçüé®" },
                { id: 'lucky', icon: "üë®üèæ", cost: 7777, type: 'passive', value: 0, trigger: g => g.total >= 5000 },
                { id: 'modeling', icon: "üì∏", cost: 10000, type: 'building_mult', bId: 1, value: 2, trigger: g => g.buildings[1] >= 10 },
                { id: 'vini', icon: "üë®üèªüìû", cost: 15000, type: 'global_mult', value: 1.3, trigger: g => g.total >= 10000, visual: "üë®üèª" },
                { id: 'naomi', icon: "üîÆ", cost: 25000, type: 'passive', value: 0, trigger: g => g.loc >= 3, visual: "üîÆ" }, 
                { id: 'richi', icon: "üèÉüèæ‚Äç‚ôÇÔ∏è", cost: 40000, type: 'building_mult', bId: 3, value: 2, trigger: g => g.loc >= 6, visual: "üèÉüèæ‚Äç‚ôÇÔ∏è" }, 
                { id: 'orsidia', icon: "üëØ‚Äç‚ôÄÔ∏è", cost: 50000, type: 'global_mult', value: 1.4, trigger: g => g.total >= 25000, visual: "üëØ‚Äç‚ôÄÔ∏è" },
                { id: 'bao', icon: "üë®üèªüèÖ", cost: 75000, type: 'click_mult', value: 1.25, trigger: g => g.total >= 40000, visual: "üèÖ" },
                { id: 'adri', icon: "üë©üèæ", cost: 150000, type: 'global_mult', value: 2.0, trigger: g => g.loc >= 4, visual: "üïäÔ∏è" }, 
                { id: 'cat', icon: "üêà", cost: 250000, type: 'global_mult', value: 1.1, trigger: g => g.total >= 100000, visual: "üêà" },
                { id: 'boss_woman', icon: "üë©üèª‚Äçüíº", cost: 400000, type: 'global_mult', value: 1.5, trigger: g => g.buildings[6] > 0 },
                { id: 'fertilizer', icon: "üå±", cost: 500000, type: 'building_mult', bId: 4, value: 2, trigger: g => g.buildings[4] >= 5 },
                { id: 'nguyen', icon: "üèÜ", cost: 750000, type: 'global_mult', value: 1.5, trigger: g => g.total >= 500000 },
                { id: 'trade_deal', icon: "ü§ù", cost: 1000000, type: 'global_mult', value: 1.5, trigger: g => g.total >= 500000 }
            ],
            news: [
                { id: 'n_start_1', req: g => g.loc === 0 },
                { id: 'n_matchyar', req: g => g.loc === 0 && mps >= 100 },
                { id: 'n_start_2', req: g => g.loc === 0 },
                { id: 'n_spain_1', req: g => g.loc === 1 },
                { id: 'n_spain_2', req: g => g.loc === 1 },
                { id: 'n_nl_1', req: g => g.loc === 2 },
                { id: 'n_nl_2', req: g => g.loc === 2 },
                { id: 'n_uk_1', req: g => g.loc === 3 },
                { id: 'n_uk_2', req: g => g.loc === 3 },
                { id: 'n_guyana', req: g => g.loc === 4 },
                { id: 'n_adri', req: g => g.upgrades.includes('adri') },
                { id: 'n_suri_1', req: g => g.loc === 5 },
                { id: 'n_suri_2', req: g => g.loc === 5 },
                { id: 'n_richi', req: g => g.upgrades.includes('richi') },
                { id: 'n_vn_1', req: g => g.loc === 7 },
                { id: 'n_vn_2', req: g => g.loc === 7 },
                { id: 'n_lili', req: g => g.buildings[1] >= 25 },
                { id: 'n_lili_2', req: g => g.buildings[1] > 2 },
                { id: 'n_lucky', req: g => g.upgrades.includes('lucky') },
                { id: 'n_naomi', req: g => g.upgrades.includes('naomi') },
                { id: 'n_orsi', req: g => g.upgrades.includes('orsidia') },
                { id: 'n_cat', req: g => g.upgrades.includes('cat') },
                { id: 'n_bao', req: g => g.upgrades.includes('bao') },
                { id: 'n_boss', req: g => g.upgrades.includes('boss_woman') },
                { id: 'n_sci', req: g => mps > 5000 },
                { id: 'n_blackhole', req: g => mps > 50000 },
                { id: 'n_save', req: g => mps > 200000 },
                { id: 'n_aliens', req: g => mps > 1000000 },
                { id: 'n_earth', req: g => g.loc === 8 },
                { id: 'n_dylan_10', req: g => g.total >= 10 && g.total < 100 },
                { id: 'n_dylan_100', req: g => g.total >= 100 && g.total < 1000 },
                { id: 'n_dylan_1k', req: g => g.total >= 1000 && g.total < 10000 },
                { id: 'n_dylan_10k', req: g => g.total >= 10000 && g.total < 100000 },
                { id: 'n_dylan_100k', req: g => g.total >= 100000 && g.total < 1000000 },
                { id: 'n_dylan_1m', req: g => g.total >= 1000000 },
                { id: 'n_dylan_10m', req: g => g.total >= 10000000 },
                { id: 'n_gen_1', req: g => true },
                { id: 'n_gen_2', req: g => true },
                { id: 'n_gen_3', req: g => true },
                { id: 'n_gen_4', req: g => true },
                { id: 'n_gen_5', req: g => true },
                // Dynamic Dylan News special handling in spawn
                { id: 'n_dylan', req: g => g.upgrades.includes('dylan') }
            ]
        };

        let state = { res: 0, total: 0, buildings: [0,0,0,0,0,0,0,0], buildingProduction: [0,0,0,0,0,0,0,0], upgrades: [], visuals: [], loc: 0 };
        let mps = 0, clickPower = 1, clickHistory = [];
        let buildingMPS = [0,0,0,0,0,0,0,0]; 
        let audioCtx, isMuted = false, musicTimer, noteIndex = 0;
        let newsPaused = false;
        let recentNews = []; 
        let dylanTimer = 0;
        let heartTimer = 0;
        let dylanAngle = 0;
        let cafeSprites = [];

        function init() {
            load();
            while(state.buildings.length < 8) state.buildings.push(0);
            while(state.buildingProduction.length < 8) state.buildingProduction.push(0);
            while(buildingMPS.length < 8) buildingMPS.push(0);

            CONFIG.upgrades.sort((a, b) => a.cost - b.cost);

            applyLocationTheme();
            renderShop();
            recalc();
            syncCafeSprites();
            startNewsCycle();
            
            setInterval(() => {
                updateCafePhysics();
            }, 1000/60);

            setInterval(() => { 
                const dt = 1 / CONFIG.fps;
                if(mps > 0) {
                    const tick = mps * dt;
                    addRes(tick); 
                    CONFIG.buildings.forEach((b, i) => {
                        state.buildingProduction[i] += (buildingMPS[i] * dt);
                    });
                }
                updateDylan(dt);
                updateHeart(dt);
            }, 1000 / CONFIG.fps);
            setInterval(() => { updateUI(); checkLocationUnlock(); updateActiveRPS(); }, 200);
            setInterval(save, 5000);
        }

        /* --- ORBIT LOGIC --- */
        function updateDylan(dt) {
            if (!state.upgrades.includes('dylan')) {
                document.getElementById('dylan-orbit-wrapper').style.display = 'none';
                return;
            }
            document.getElementById('dylan-orbit-wrapper').style.display = 'block';
            
            // Calculate Position via JS, No CSS Rotation so Sprite stays upright
            dylanAngle += dt * 0.5; // Orbit speed
            const radius = 100; // Radius (Closer)
            const x = Math.cos(dylanAngle) * radius;
            const y = Math.sin(dylanAngle) * radius;
            
            const sprite = document.getElementById('dylan-sprite');
            // Reset margin for animation base state
            if(!sprite.classList.contains('hitting')) {
                sprite.style.marginTop = "0px";
            }
            sprite.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%)`;

            let interval = 10;
            if (state.upgrades.includes('dylan_2')) interval = 6;
            if (state.upgrades.includes('dylan_3')) interval = 3;
            if (state.upgrades.includes('dylan_4')) interval = 1.5;
            if (state.upgrades.includes('dylan_5')) interval = 0.5;
            if (state.upgrades.includes('dylan_6')) interval = 0.1;

            dylanTimer += dt;
            if (dylanTimer >= interval) {
                dylanTimer = 0;
                doClick(true, 'dylan');
            }
        }

        function updateHeart(dt) {
            if (!state.upgrades.includes('unending_love')) {
                document.getElementById('heart-orbit-wrapper').style.display = 'none';
                return;
            }
            document.getElementById('heart-orbit-wrapper').style.display = 'block';
            
            const angle = -dylanAngle; // Counter rotate
            const radius = 130;
            const x = Math.cos(angle) * radius;
            const y = Math.sin(angle) * radius;
            
            const sprite = document.getElementById('heart-sprite');
            if(!sprite.classList.contains('hitting')) {
                sprite.style.marginTop = "0px";
            }
            sprite.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%)`;

            let interval = 10;
            if (state.upgrades.includes('dylan_2')) interval = 6;
            if (state.upgrades.includes('dylan_3')) interval = 3;
            if (state.upgrades.includes('dylan_4')) interval = 1.5;
            if (state.upgrades.includes('dylan_5')) interval = 0.5;
            if (state.upgrades.includes('dylan_6')) interval = 0.1;

            heartTimer += dt;
            if (heartTimer >= interval) {
                heartTimer = 0;
                doClick(true, 'heart');
            }
        }

        /* --- CAFE VISUALS --- */
        function syncCafeSprites() {
            const newSprites = [];
            
            // 1. Buildings
            CONFIG.buildings.forEach((b, i) => {
                const count = state.buildings[i];
                if (count > 0) {
                    let sym = b.symbol;
                    if (count >= 50) sym = b.evolved2.symbol;
                    else if (count >= 25) sym = b.evolved.symbol;

                    const existing = cafeSprites.filter(s => s.type === 'building' && s.id === i);
                    existing.forEach(s => { s.symbol = sym; s.el.innerText = sym; });

                    const targetCount = Math.min(count, 5);
                    for(let k=0; k<existing.length; k++) {
                        if(k < targetCount) newSprites.push(existing[k]);
                        else existing[k].el.remove();
                    }
                    for(let k=existing.length; k<targetCount; k++) {
                        newSprites.push(createBouncingElement(sym, 'building', i));
                    }
                }
            });

            // 2. Upgrades (Special Sprites)
            CONFIG.upgrades.forEach(u => {
                if(u.visual && state.upgrades.includes(u.id)) {
                    // Check if already exists
                    const existing = cafeSprites.find(s => s.type === 'upgrade' && s.id === u.id);
                    if(existing) {
                        newSprites.push(existing);
                    } else {
                        newSprites.push(createBouncingElement(u.visual, 'upgrade', u.id));
                    }
                }
            });
            
            // Clean up
            cafeSprites.forEach(s => {
                if(!newSprites.includes(s)) s.el.remove();
            });

            cafeSprites = newSprites;
        }

        function createBouncingElement(sym, type, id) {
            // Ensure container exists
            const container = document.getElementById('sprite-container');
            if(!container) return null;

            const el = document.createElement('div');
            el.className = 'bouncing-sprite';
            el.innerText = sym;
            container.appendChild(el);
            
            let speedMult = 1;
            if (type === 'upgrade' && id === 'richi') speedMult = 3;

            return {
                x: Math.random() * 90,
                y: Math.random() * 80,
                vx: (Math.random() - 0.5) * 0.5 * speedMult,
                vy: (Math.random() - 0.5) * 0.5 * speedMult,
                symbol: sym,
                type: type,
                id: id,
                el: el
            };
        }

        function updateCafePhysics() {
            cafeSprites.forEach(s => {
                if(!s.el) return;
                s.x += s.vx;
                s.y += s.vy;
                if (s.x <= 0 || s.x >= 95) s.vx *= -1;
                if (s.y <= 0 || s.y >= 90) s.vy *= -1;
                s.el.style.left = s.x + '%';
                s.el.style.top = s.y + '%';
            });
        }

        function showNewspaper(headline, body) {
            document.getElementById('np-headline').innerText = headline;
            document.getElementById('np-body').innerText = body;
            document.getElementById('newspaper-overlay').style.display = 'flex';
        }
        function closeNewspaper() { document.getElementById('newspaper-overlay').style.display = 'none'; }

        /* --- MENUS & MAP --- */
        function toggleMenu() {
            const el = document.getElementById('menu-overlay');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
            document.getElementById('mute-btn-menu').innerText = isMuted ? "üîá SOUND OFF" : "üîä SOUND ON";
        }

        function toggleMap() {
            const el = document.getElementById('map-overlay');
            if(el.style.display === 'flex') {
                el.style.display = 'none';
            } else {
                renderMap();
                el.style.display = 'flex';
                document.getElementById('menu-overlay').style.display = 'none';
            }
        }

        function renderMap() {
            const container = document.getElementById('map-container');
            const oldPins = container.querySelectorAll('.map-pin');
            oldPins.forEach(p => p.remove());
            
            CONFIG.locations.forEach((loc, index) => {
                if(loc.id === 8 && state.loc < 8) return; 

                const isActive = state.loc === index;
                const isPassed = state.loc > index;
                
                const pin = document.createElement('div');
                pin.className = `map-pin ${isActive ? 'active' : ''} ${!isActive && !isPassed ? 'locked' : ''}`;
                
                if (loc.coords) {
                    pin.style.top = loc.coords.top;
                    pin.style.left = loc.coords.left;
                }

                const tip = document.createElement('div');
                tip.className = 'map-tooltip';
                tip.innerText = `${loc.flag} ${getText('loc_'+index)}`;
                pin.appendChild(tip);

                container.appendChild(pin);
            });
        }

        function toggleStats() {
            const el = document.getElementById('stats-overlay');
            if (el.style.display === 'flex') {
                el.style.display = 'none';
            } else {
                updateStatsContent();
                el.style.display = 'flex';
                document.getElementById('menu-overlay').style.display = 'none';
            }
        }

        /* --- CONTINUOUS NEWS TICKER --- */
        let newsTrack = document.getElementById('news-track');
        let newsSpeed = 0.8; 
        
        function startNewsCycle() {
            requestAnimationFrame(animateNews);
        }

        function pauseNews() { newsPaused = true; }
        function resumeNews() { newsPaused = false; }

        function animateNews() {
            if(!newsPaused) {
                const items = document.querySelectorAll('.news-item');
                if (items.length === 0) {
                    spawnNewsItem();
                } else {
                    const lastItem = items[items.length - 1];
                    const rect = lastItem.getBoundingClientRect();
                    const containerRect = document.getElementById('news-bar').getBoundingClientRect();
                    if (rect.right < containerRect.right - 100) {
                        spawnNewsItem();
                    }
                }

                items.forEach(item => {
                    let currentLeft = parseFloat(item.style.left);
                    item.style.left = (currentLeft - newsSpeed) + 'px';
                    if (currentLeft < -item.offsetWidth) {
                        item.remove();
                    }
                });
            }
            requestAnimationFrame(animateNews);
        }

        function spawnNewsItem() {
            const availableNews = CONFIG.news.filter(n => n.req(state));
            if (availableNews.length === 0) return;
            
            let pool = availableNews.filter(n => {
                const t = getText(n.id);
                if(n.id === 'n_dylan') return !recentNews.includes(n.id);
                return !recentNews.includes(t);
            });
            
            if (pool.length === 0) pool = availableNews;

            const rand = pool[Math.floor(Math.random() * pool.length)];
            let text = getText(rand.id);
            
            if(rand.id === 'n_dylan') {
                text = text.replace('{n}', Math.floor(state.total).toLocaleString());
            }
            
            recentNews.push(text);
            if(recentNews.length > 5) recentNews.shift();

            const span = document.createElement('span');
            span.className = 'news-item';
            span.style.position = 'absolute';
            span.style.left = document.getElementById('news-bar').offsetWidth + 'px'; 
            span.innerText = text + " ‚Ä¢ ";
            document.getElementById('news-track').appendChild(span);
        }

        /* --- UI RENDERERS --- */
        function renderShop() {
            const bContainer = document.getElementById('tab-buildings');
            bContainer.innerHTML = '';
            CONFIG.buildings.forEach((b, i) => {
                const div = document.createElement('div');
                div.className = 'shop-item disabled';
                div.id = `build-${i}`;
                div.onclick = () => buyBuilding(i);
                
                // Helper to get translated name/desc
                const getNameDesc = (count) => {
                    let n = getText(`b${i}_n`);
                    let d = getText(`b${i}_d`);
                    let s = b.symbol;
                    if(count >= 50) {
                        n = getText(`b${i}_n_t3`) || n;
                        d = getText(`b${i}_d_t3`) || d;
                        s = b.evolved2.symbol;
                        d += " (x4!)";
                    } else if(count >= 25) {
                        n = getText(`b${i}_n_t2`) || n;
                        d = getText(`b${i}_d_t2`) || d;
                        s = b.evolved.symbol;
                        d += " (x2!)";
                    }
                    if(count >= 100) d += " (x10000!)";
                    return {n, d, s};
                };

                div.onmouseenter = () => {
                    const count = state.buildings[i];
                    const info = getNameDesc(count);
                    showInfo(info.s, info.n, info.d, `Cost: ${Math.floor(b.baseCost * Math.pow(1.15, count)).toLocaleString()}`);
                };
                div.onmouseleave = clearInfo;
                div.innerHTML = `
                    <div class="item-icon" id="icon-${i}">${b.symbol}</div>
                    <div class="item-details"><h3 id="name-${i}"></h3></div>
                    <div class="item-right">
                        <div class="item-cost" id="cost-${i}">0</div>
                        <div class="item-count" id="count-${i}">0</div>
                    </div>
                `;
                bContainer.appendChild(div);
            });

            const uContainer = document.getElementById('upgrades-list');
            uContainer.innerHTML = '';
            CONFIG.upgrades.forEach(u => {
                const div = document.createElement('div');
                div.className = 'upgrade-card';
                div.id = `upg-${u.id}`;
                div.style.display = 'none';
                div.innerHTML = `${u.icon}`;
                div.onclick = () => buyUpgrade(u.id);
                div.onmouseenter = () => showInfo(u.icon, getText(`u_${u.id}`), getText(`u_${u.id}_d`), `Cost: ${u.cost.toLocaleString()}`);
                div.onmouseleave = clearInfo;
                uContainer.appendChild(div);
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            const btns = document.querySelectorAll('.tab-btn');
            if(tab === 'buildings') btns[0].classList.add('active');
            if(tab === 'upgrades') btns[1].classList.add('active');
            if(tab === 'passport') {
                btns[2].classList.add('active');
                updatePassport();
            }
        }

        function showInfo(icon, title, desc, cost) {
            document.getElementById('info-icon-container').innerText = icon;
            document.getElementById('info-title').innerText = title;
            document.getElementById('info-desc').innerText = desc;
            document.getElementById('info-cost').innerText = cost;
        }

        function clearInfo() {
            document.getElementById('info-icon-container').innerText = "?";
            document.getElementById('info-title').innerText = getText('welcome');
            document.getElementById('info-desc').innerText = getText('hover_info');
            document.getElementById('info-cost').innerText = "";
        }

        function updatePassport() {
            const list = document.getElementById('passives-list');
            list.innerHTML = '';
            if(state.upgrades.length === 0) {
                list.innerHTML = '<div style="color:#999; font-style:italic;">...</div>';
                return;
            }
            state.upgrades.forEach(uid => {
                const u = CONFIG.upgrades.find(x => x.id === uid);
                if(u) {
                    const div = document.createElement('div');
                    div.className = 'passive-row';
                    div.innerHTML = `<span style="font-size:1.5rem; margin-right:10px;">${u.icon}</span> <strong>${getText(`u_${u.id}`)}</strong>`;
                    list.appendChild(div);
                }
            });
            const loc = CONFIG.locations[state.loc];
            document.getElementById('passport-loc').innerText = `${getText('loc_'+state.loc)} ${loc.flag}`;
            document.getElementById('passport-mult').innerText = `Mult: x${loc.multiplier}`;
        }

        function updateStatsContent() {
            const container = document.getElementById('stats-content');
            let bHtml = '<table class="stats-table"><tr><th>Building</th><th>Owned</th><th>Total</th></tr>';
            CONFIG.buildings.forEach((b, i) => {
                if(state.buildings[i] > 0) {
                    let n = getText(`b${i}_n`);
                    if(state.buildings[i]>=50) n = getText(`b${i}_n_t3`) || n;
                    else if(state.buildings[i]>=25) n = getText(`b${i}_n_t2`) || n;

                    const val = Math.floor(state.buildingProduction[i]).toLocaleString();
                    bHtml += `<tr><td>${n}</td><td>${state.buildings[i]}</td><td>${val}</td></tr>`;
                }
            });
            bHtml += '</table>';
            container.innerHTML = `<p><strong>Total:</strong> ${Math.floor(state.total).toLocaleString()}</p><p><strong>MPS:</strong> ${mps.toFixed(1)}</p><hr>${bHtml}`;
        }

        function addRes(n) {
            state.res += n; state.total += n;
            document.getElementById('resource-count').innerText = Math.floor(state.res).toLocaleString();
        }

        function doClick(auto = false, source = 'user') {
            let amount = clickPower;
            let isCrit = false;
            let critChance = 0;
            if(state.upgrades.includes('lucky')) critChance += 0.1;
            if(state.upgrades.includes('naomi')) critChance += 0.1;
            if(Math.random() < critChance) { amount *= 2; isCrit = true; }
            
            addRes(amount);
            
            const btn = document.getElementById('click-btn');
            
            if(!auto) {
                clickHistory.push(Date.now());
                sfxClick();
                const rect = btn.getBoundingClientRect();
                const containerRect = document.getElementById('click-btn-container').getBoundingClientRect();
                const x = (rect.left - containerRect.left) + Math.random() * rect.width;
                const y = (rect.top - containerRect.top) + Math.random() * rect.height;
                spawnFloat(amount, isCrit, x, y);
            } else {
                btn.classList.add('bump');
                setTimeout(() => btn.classList.remove('bump'), 150);
                if(source === 'dylan') {
                    const el = document.getElementById('dylan-sprite');
                    if(el) { el.classList.add('hitting'); setTimeout(() => el.classList.remove('hitting'), 150); }
                } else if (source === 'heart') {
                    const el = document.getElementById('heart-sprite');
                    if(el) { el.classList.add('hitting'); setTimeout(() => el.classList.remove('hitting'), 150); }
                }
                const btnContainer = document.getElementById('click-btn-container');
                spawnFloat(amount, isCrit, btnContainer.offsetWidth/2, btnContainer.offsetHeight/2 - 20);
            }
        }
        
        function spawnFloat(amount, isCrit, x, y) {
            const float = document.createElement('div');
            float.className = isCrit ? 'floater crit' : 'floater';
            float.innerText = `+${Math.floor(amount)}` + (isCrit ? "!" : "");
            float.style.left = x + 'px';
            float.style.top = y + 'px';
            document.getElementById('click-btn-container').appendChild(float);
            setTimeout(() => float.remove(), 800);
        }

        document.getElementById('click-btn').addEventListener('mousedown', (e) => doClick(false));

        function buyBuilding(id) {
            const cost = Math.floor(CONFIG.buildings[id].baseCost * Math.pow(1.15, state.buildings[id]));
            if(state.res >= cost) {
                state.res -= cost;
                state.buildings[id]++;
                sfxBuy();
                // Evolution Newspaper
                if(state.buildings[id] === 25) {
                    showNewspaper(getText(`b${id}_n_t2`), getText('loc_new') + " Evolution!"); // simplified
                } else if(state.buildings[id] === 50) {
                    showNewspaper(getText(`b${id}_n_t3`), "TIER 3 REACHED!");
                }
                recalc(); updateUI(); syncCafeSprites();
            }
        }

        function buyUpgrade(id) {
            const u = CONFIG.upgrades.find(x => x.id === id);
            if(u && state.res >= u.cost && !state.upgrades.includes(id)) {
                state.res -= u.cost;
                state.upgrades.push(id);
                sfxBuy();
                recalc(); updateUI(); syncCafeSprites();
            }
        }

        function recalc() {
            let mult = CONFIG.locations[state.loc].multiplier;
            let clickM = 1, clickF = 0, clickP = 0, bMults = [1,1,1,1,1,1,1,1];
            state.upgrades.forEach(uid => {
                const u = CONFIG.upgrades.find(x => x.id === uid);
                if(u.type === 'global_mult') mult *= u.value;
                if(u.type === 'click_mult') clickM *= u.value;
                if(u.type === 'click_flat') clickF += u.value;
                if(u.type === 'click_percent_mps') clickP += u.value;
                if(u.type === 'building_mult') bMults[u.bId] *= u.value;
            });
            let rawMps = 0;
            buildingMPS = [0,0,0,0,0,0,0,0];
            CONFIG.buildings.forEach((b, i) => {
                let production = b.baseProd * state.buildings[i];
                if(state.buildings[i] >= 100) production *= 10000;
                else if(state.buildings[i] >= 50) production *= 4;
                else if(state.buildings[i] >= 25) production *= 2;
                
                const finalProd = production * bMults[i];
                buildingMPS[i] = finalProd * mult;
                rawMps += finalProd;
            });
            mps = rawMps * mult;
            let baseClick = (1 + clickF) * clickM * CONFIG.locations[state.loc].multiplier;
            clickPower = baseClick + (mps * clickP);
        }

        function updateUI() {
            CONFIG.buildings.forEach((b, i) => {
                const count = state.buildings[i];
                const cost = Math.floor(b.baseCost * Math.pow(1.15, count));
                const el = document.getElementById(`build-${i}`);
                
                let n = getText(`b${i}_n`);
                let s = b.symbol;
                if(count>=50) { n=getText(`b${i}_n_t3`) || n; s=b.evolved2.symbol; }
                else if(count>=25) { n=getText(`b${i}_n_t2`) || n; s=b.evolved.symbol; }

                document.getElementById(`name-${i}`).innerText = n;
                document.getElementById(`icon-${i}`).innerText = s;
                document.getElementById(`cost-${i}`).innerText = cost.toLocaleString();
                document.getElementById(`count-${i}`).innerText = count;

                if(state.res >= cost) el.classList.remove('disabled'); else el.classList.add('disabled');
            });
            CONFIG.upgrades.forEach(u => {
                const el = document.getElementById(`upg-${u.id}`);
                if(state.upgrades.includes(u.id)) { el.style.display = 'none'; } 
                else if(u.trigger(state)) { el.style.display = 'flex'; if(state.res >= u.cost) el.classList.remove('disabled'); else el.classList.add('disabled'); }
            });
            
            const nextLoc = CONFIG.locations[state.loc + 1];
            const goalText = document.getElementById('goal-text');
            const bar = document.getElementById('goal-progress');
            const goalLabel = getText('goal_prefix');
            
            if (nextLoc) {
                goalText.innerText = `${goalLabel} ${getText('loc_'+(state.loc+1))} (${nextLoc.threshold.toLocaleString()})`;
                const pct = Math.min(100, (mps / nextLoc.threshold) * 100);
                bar.style.width = `${pct}%`;
            } else {
                goalText.innerText = getText('goal_global');
                bar.style.width = "100%";
            }
        }
        
        function updateActiveRPS() {
            const now = Date.now();
            clickHistory = clickHistory.filter(t => now - t < 1000);
            const uiActive = clickHistory.length * clickPower;
            document.getElementById('rps-display').innerText = `${(mps + uiActive).toFixed(1)} / SEC`;
            const el = document.getElementById('active-rps');
            el.innerText = uiActive > 0 ? `(+${uiActive.toFixed(1)})` : "";
        }

        function checkLocationUnlock() {
            const nextLocIdx = state.loc + 1;
            if(nextLocIdx < CONFIG.locations.length && mps >= CONFIG.locations[nextLocIdx].threshold) {
                const prevLocName = CONFIG.locations[state.loc].name;
                state.loc = nextLocIdx;
                applyLocationTheme();
                recalc();
                startMusic(); 
                showNewspaper(
                    getText('loc_new'), 
                    `${getText('loc_arrived')} ${getText('loc_'+nextLocIdx)}!`
                );
            }
        }
        
        function applyLocationTheme() {
            const loc = CONFIG.locations[state.loc];
            const r = document.documentElement.style;
            const snow = document.querySelectorAll('.snowflake');
            if (state.loc === 0) { if (snow.length === 0) createSnow(); } else { snow.forEach(s => s.remove()); }
            r.setProperty('--bg-color', loc.colors.bg);
            r.setProperty('--bg-pattern', loc.colors.pat);
            r.setProperty('--primary', loc.colors.pri);
            r.setProperty('--accent', loc.colors.acc);
            r.setProperty('--text-color', loc.colors.txt || '#212121');
        }

        function createSnow() {
            for(let i=0; i<50; i++) {
                const s = document.createElement('div');
                s.className = 'snowflake';
                s.innerText = '‚ùÑ';
                s.style.left = Math.random() * 100 + 'vw';
                s.style.animationDuration = (Math.random() * 3 + 2) + 's';
                s.style.fontSize = (Math.random() * 10 + 10) + 'px';
                s.style.opacity = Math.random();
                document.body.appendChild(s);
            }
        }

        function startGame() { 
            document.getElementById('tutorial-overlay').style.display = 'none'; 
            gameStarted = true;
            initAudio(); 
        }
        
        function closeLocPopup() { document.getElementById('location-popup').style.display = 'none'; }
        function save() { localStorage.setItem('haniVibrantSave', JSON.stringify(state)); }
        function load() { const d = localStorage.getItem('haniVibrantSave'); if(d) { const saved = JSON.parse(d); state = {...state, ...saved}; gameStarted = true; } }
        function resetGame() { localStorage.removeItem('haniVibrantSave'); location.reload(); }

        function initAudio() { if(!audioCtx) { audioCtx = new (window.AudioContext||window.webkitAudioContext)(); startMusic(); } else if(audioCtx.state==='suspended') audioCtx.resume(); }
        function playTone(freq,type,dur,vol) { if(isMuted||!audioCtx)return; const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type=type;o.frequency.setValueAtTime(freq,audioCtx.currentTime);g.gain.setValueAtTime(vol,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+dur);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+dur); }
        function startMusic() { if(musicTimer) clearInterval(musicTimer); const notes = CONFIG.locations[state.loc].music; noteIndex = 0; musicTimer = setInterval(() => { if(!isMuted && audioCtx && audioCtx.state === 'running') { playTone(notes[noteIndex], 'triangle', 0.3, 0.05); noteIndex = (noteIndex + 1) % notes.length; } }, 400); }
        function sfxClick() { if(!audioCtx)initAudio(); playTone(880,'sine',0.1,0.1); }
        function sfxBuy() { if(!audioCtx)initAudio(); playTone(1046,'square',0.1,0.05); setTimeout(()=>playTone(1318,'square',0.2,0.05),100); }
        function toggleAudio() { isMuted=!isMuted; document.getElementById('mute-btn-menu').innerText=isMuted?"üîá SOUND OFF":"üîä SOUND ON"; if(!isMuted&&audioCtx&&audioCtx.state==='suspended') audioCtx.resume(); }

        init();
    </script>
</body>
</html>